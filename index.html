<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-93EGC4CGNR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-93EGC4CGNR');
    </script>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <title>Ladder Word Game - Daily Word Puzzle | Free Online</title>
    <meta name="description" content="Play Ladder, the #1 daily word game! Transform words by changing one letter at a time in this addictive word chain puzzle. Free ladder word game with new puzzles daily.">
    <meta name="keywords" content="ladder word game, word ladder, word chain puzzle, daily word game, word transformation game, free word puzzle, online word game, vocabulary game, brain training, word ladder puzzle"
    <meta name="author" content="Ladder Game">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://ladder.game/">
    
    <!-- PWA Meta Tags for Full Screen Experience -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Ladder">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#fafafa">
    <meta name="msapplication-navbutton-color" content="#fafafa">
    <meta name="msapplication-TileColor" content="#fafafa">
    
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="Ladder Word Game - Free Daily Word Chain Puzzle">
    <meta property="og:description" content="Play the addictive ladder word game! Transform words by changing one letter at a time. Free daily word puzzles with progressive difficulty. Start your word ladder challenge now!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ladder.game/">
    <meta property="og:image" content="https://ladder.game/assets/icons/icon-512.png">
    <meta property="og:site_name" content="Ladder Word Game">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ladder Word Game - Free Daily Word Puzzle">
    <meta name="twitter:description" content="Transform words by changing one letter at a time! Play this addictive ladder word game for free with new daily puzzles.">
    <meta name="twitter:image" content="https://ladder.game/assets/icons/icon-512.png">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="./assets/icons/icon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/icons/icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./assets/icons/icon-512.png">
    <link rel="manifest" href="./manifest.json">
    
    <!-- Structured Data for Google -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Game",
        "name": "Ladder Word Game",
        "alternateName": ["LADDER", "Word Ladder", "Daily Word Chain", "Word Transformation Game"],
        "description": "Play Ladder, the premier word ladder game! Transform words by changing one letter at a time in this addictive daily word chain puzzle. Free online word game with new challenging puzzles every day. Perfect for vocabulary building and brain training.",
        "url": "https://ladder.game/",
        "image": "https://ladder.game/assets/icons/icon-512.png",
        "applicationCategory": "Game",
        "operatingSystem": "Web Browser",
        "genre": ["Word Game", "Puzzle Game", "Brain Game", "Word Ladder", "Educational Game"],
        "keywords": "ladder word game, word ladder, word chain puzzle, daily word game, word transformation game, free word puzzle, online word game, vocabulary game, brain training, word ladder puzzle",
        "isAccessibleForFree": true,
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "availability": "https://schema.org/InStock"
        },
        "gameItem": {
            "@type": "Thing",
            "name": "Daily Word Ladder Puzzle",
            "description": "Transform words by changing one letter at a time in this challenging word chain game"
        },
        "publisher": {
            "@type": "Organization",
            "name": "Ladder Word Game",
            "url": "https://ladder.game/",
            "sameAs": ["https://ladder.game/"]
        },
        "creator": {
            "@type": "Organization",
            "name": "Ladder Word Game"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "1247",
            "bestRating": "5",
            "worstRating": "1"
        },
        "audience": {
            "@type": "Audience",
            "audienceType": "Word game enthusiasts, puzzle lovers, vocabulary builders"
        },
        "educationalUse": "Vocabulary building, word recognition, logical thinking",
        "learningResourceType": "Game",
        "interactivityType": "active",
        "isPartOf": {
            "@type": "WebSite",
            "@id": "https://ladder.game/"
        }
    }
    </script>
    
    <style>
        /* PWA Full Screen Support */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
            
            /* LADDER Color Palette - Design System */
            /* Green Theme - Success & Completion */
            --primary-green: #6aaa64;
            --primary-green-hover: #5d9556;
            
            /* Orange Theme - Active & Selection States */  
            --primary-orange: #ff8c42;
            --primary-orange-hover: #e06829;
            
            /* Error & Warning States */
            --error-red: #e74c3c;
            --error-red-dark: #c0392b;
            
            /* Neutral Gray System */
            --gray-50: #fafafa;         /* Light background */
            --gray-200: #d3d6da;        /* Borders, default states */
            --gray-400: #a8adb3;        /* Intermediate tone, hover states */
            --gray-600: #787c7e;        /* Secondary text, labels */
            --gray-900: #1a1a1b;        /* Primary text */
        }
        
        html {
            height: 100vh;
            height: -webkit-fill-available;
            background-color: #fafafa; /* Ensure background extends to status bar */
            overscroll-behavior: none; /* Prevent bounce/overscroll */
        }
        
        /* Hide scrollbars in PWA mode */
        @media (display-mode: fullscreen), (display-mode: standalone) {
            html {
                overflow: hidden;
                overscroll-behavior: none; /* Prevent overscroll bounce in PWA */
            }
            body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: none; /* Prevent overscroll bounce in PWA */
                background-color: var(--gray-50); /* Force background color in PWA */
            }
            ::-webkit-scrollbar {
                display: none;
            }
            /* Ensure content doesn't render under system UI */
            body {
                padding-top: env(safe-area-inset-top, 0);
                padding-bottom: env(safe-area-inset-bottom, 0);
                padding-left: env(safe-area-inset-left, 0);
                padding-right: env(safe-area-inset-right, 0);
            }
            
            /* Force background for PWA container */
            .container {
                background-color: var(--gray-50) !important;
                overscroll-behavior: none !important;
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top, 0);
            padding-right: env(safe-area-inset-right, 0);
            padding-bottom: env(safe-area-inset-bottom, 0);
            padding-left: env(safe-area-inset-left, 0);
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards;
            overscroll-behavior: none; /* Prevent overscroll bounce showing green */
            /* Prevent zoom gestures */
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--gray-50); /* Ensure consistent background */
            overscroll-behavior: none; /* Prevent overscroll bounce */
        }

        /* Desktop-only: Increase padding-top to prevent content cutoff */
        @media (min-width: 481px) {
            .container.game-page,
            .completion-page,
            .failure-page {
                padding-top: 160px;
            }
        }

        /* Landing Page Styles */
        .landing-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 0 20px 20px 20px; /* Remove top padding */
            max-width: 500px;
            margin: 0 auto;
            background-color: #fafafa; /* Ensure consistent background */
        }

        .landing-header {
            text-align: center;
            padding: 10px 0 30px; /* Reduce top padding from 20px to 10px */
            border-bottom: 1px solid #d3d6da;
            margin-bottom: 120px;
            max-width: 500px;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }

        .landing-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
            color: #1a1a1b;
        }

        .puzzle-info {
            font-size: 0.8rem;
            color: #787c7e;
            margin-bottom: 0;
        }

        .instructions {
            background: white;
            border: 1px solid #d3d6da;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 40px;
            text-align: left;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }
        
        .landing-content {
            transition: opacity 0.4s ease-out;
            margin-top: 80px; /* Push ladder and play button further down */
        }

        /* Prevent scrolling on landing page */
        body.landing-page {
            overflow: hidden;
        }
        
        body.landing-page .container {
            overflow: hidden;
            height: 100vh;
        }
        
        .landing-content.fade-out {
            opacity: 0;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 40px;
            gap: 16px;
            position: relative;
            z-index: 2;
        }

        .instruction-item:last-child {
            margin-bottom: 0;
        }

        .instruction-content {
            flex: 1;
        }

        .instruction-header {
            font-size: 1.2rem;
            color: var(--primary-green);
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .instruction-text {
            font-size: 1rem;
            color: #787c7e;
            line-height: 1.4;
        }

        .instruction-logo {
            text-align: center;
            margin-bottom: 12px;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.2s forwards;
        }

        .ladder-icon {
            width: 220px;
            height: 220px;
            opacity: 0.9;
        }

        .week-difficulty-text {
            text-align: center;
            color: #787c7e;
            font-size: 0.9rem;
            margin-top: 16px;
            margin-bottom: 0;
            line-height: 1.4;
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.7s forwards;
            max-width: clamp(220px, 60vw, 260px);
            margin-left: auto;
            margin-right: auto;
        }

        /* Entrance animations */
        .instructions {
            animation: slideUpFade 0.6s ease-out;
        }

        .instruction-item {
            opacity: 0;
            transform: translateY(20px);
            animation: climbUp 0.5s ease-out forwards;
        }

        .instruction-item:nth-child(1) { animation-delay: 0.0s; }
        .instruction-item:nth-child(2) { animation-delay: 0.1s; }
        .instruction-item:nth-child(3) { animation-delay: 0.2s; }

        .play-button {
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.5s forwards;
            background: white;
            color: var(--primary-green);
            border: 3px solid var(--primary-green);
            border-radius: 10px;
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.01em;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            width: clamp(220px, 60vw, 260px);
            max-width: none;
            display: block;
            margin: 0 auto;
            transform: scale(1);
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes climbUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .play-button.green {
            background: var(--primary-green);
            color: white;
            font-weight: 800;
            border-color: var(--primary-green);
        }

        .play-button:not(:disabled):not(.animating):hover {
            background: #f8f9fa;
            border-color: var(--primary-green);
            color: var(--primary-green);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.15);
        }

        .play-button:not(:disabled):active {
            background: #f0f2f0;
            border-color: var(--primary-green);
            color: var(--primary-green);
            transform: translateY(0px) scale(0.98);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .play-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: scale(1) !important;
        }

        /* Game Page Styles */
        .game-page {
            display: none;
            transition: opacity 0.4s ease-out;
        }
        
        .game-content {
            transition: opacity 0.2s ease-out;
        }
        
        .game-content.fade-out {
            opacity: 0;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        /* Only add top margin for non-game pages (intro, completion, failure) */
        .landing-page .stats,
        .completion-page .stats,
        .failure-page .stats {
            margin-top: 40px;
        }

        .stat {
            text-align: center;
            min-width: 50px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a1a1b;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #787c7e;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 4px;
        }

        .timer .stat-value {
            color: #ff8c42;
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .ladder {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .rung {
            background: #ffffff;
            border: 2px solid #d3d6da;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            position: relative;
        }

        .rung.active {
            border-color: #ff8c42;
            box-shadow: 0 2px 8px rgba(255, 140, 66, 0.1);
        }

        .rung.completed {
            border-color: #6aaa64;
            background-color: #f6f7f8;
        }

        .word-display {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 8px;
        }

        .letter-box {
            width: 32px;
            height: 32px;
            border: 2px solid #d3d6da;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 600;
            background: #ffffff;
            font-family: inherit;
        }

        .letter-box.filled {
            background-color: #d3d6da;
            border-color: #d3d6da;
            color: #787c7e;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .letter-box.hint-revealed {
            background-color: white !important;
            border-color: #d3d6da !important;
            color: #ff8c42 !important;
        }
        
        /* Ensure hint letters stay orange even when filled class is also present */
        .letter-box.hint-revealed.filled {
            background-color: white !important;
            border-color: #d3d6da !important;
            color: #ff8c42 !important;
        }
        
        .letter-box.hint-revealed.current {
            /* Hint letters get orange border when selected and keep orange text */
            background-color: white !important;
            border-color: #ff8c42 !important; /* Orange border when selected */
            border-width: 2px !important; /* Same as default - no size change */
            box-shadow: 0 0 8px rgba(255, 140, 66, 0.4) !important;
            animation: pulse 1.5s infinite !important;
            color: #ff8c42 !important; /* Keep orange text color for hints */
        }
        
        .letter-box.hint-revealed.typed-through {
            background-color: #ff8c42 !important;
            border-color: #ff8c42 !important;
            color: white !important;
        }

        .word-hint {
            text-align: center;
            font-size: 0.8rem;
            color: #787c7e;
            font-style: italic;
        }

        /* Remove blue focus outline from letter boxes */
        .letter-box:focus {
            outline: none !important;
        }
        
        /* Remove touch highlight and prevent persistent scaling on mobile */
        .letter-box.interactive {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .letter-box.interactive:active {
            transform: none !important;
        }
        
        /* Disable transform for interactive boxes on touch devices completely */
        @media (hover: none) and (pointer: coarse) {
            .letter-box.interactive {
                transition: none !important;
            }
        }

        /* Only show hover effects on non-touch devices to prevent mobile scaling issues */
        @media (hover: hover) and (pointer: fine) {
            .letter-box.interactive:hover {
                transform: scale(1.1);
                border-color: #ff8c42;
            }
        }

        .letter-box.current {
            border-color: #ff8c42;
            border-width: 2px; /* Same as default - no size change */
            animation: pulse 1.5s infinite;
            background-color: rgba(255, 140, 66, 0.1);
        }

        .letter-box.user-typed {
            /* User typed letters have no background - just plain text */
            color: #1a1a1b;
        }

        .letter-box.auto-corrected {
            animation: autoCorrectFlash 0.6s ease;
        }

        .letter-box.typed-through {
            background-color: #787c7e !important;
            border-color: #787c7e !important;
            color: white !important;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 0 8px rgba(255, 140, 66, 0.4);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 0 12px rgba(255, 140, 66, 0.6);
                transform: scale(1.02);
            }
        }

        @keyframes autoCorrectFlash {
            0% { background-color: #ff8c42; border-color: #ff8c42; }
            50% { background-color: #e06829; border-color: #e06829; }
            100% { background-color: initial; border-color: initial; }
        }

        .letter-box.wrong-word {
            background-color: #e74c3c !important;
            border-color: #e74c3c !important;
            color: white !important;
            animation: shake 0.6s ease-in-out;
        }
        
        /* Override hint styling during wrong word animation */
        .letter-box.hint-revealed.wrong-word {
            background-color: #e74c3c !important;
            border-color: #e74c3c !important;
            color: white !important;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px) scale(1.05); }
            20%, 40%, 60%, 80% { transform: translateX(4px) scale(1.05); }
        }
        
        /* Failure cascade animation - reveals remaining words in red */
        .letter-box.failure-cascade {
            animation: failureCascade 0.5s ease-out;
            /* Override any current/orange styling during failure */
            border-width: 2px !important;
            box-shadow: none !important;
        }
        
        /* Ensure failure cascade overrides current class completely */
        .letter-box.failure-cascade.current,
        .letter-box.failure-cascade.filled.current {
            border-width: 2px !important;
            box-shadow: none !important;
            animation: failureCascade 0.5s ease-out !important;
            border-color: #d3d6da !important;
            background-color: transparent !important;
        }
        
        /* Additional override for any persistent current styling during failure */
        .letter-box.current.failure-cascade,
        .letter-box.filled.current.failure-cascade {
            border-color: #d3d6da !important;
            border-width: 2px !important;
            box-shadow: none !important;
            animation: failureCascade 0.5s ease-out !important;
            background-color: transparent !important;
        }
        
        /* Override hint styling during failure cascade */
        .letter-box.hint-revealed.failure-cascade,
        .letter-box.hint-revealed.current.failure-cascade,
        .letter-box.hint-revealed.filled.failure-cascade {
            border-color: #d3d6da !important;
            border-width: 2px !important;
            box-shadow: none !important;
            animation: failureCascade 0.5s ease-out !important;
            background-color: transparent !important;
            color: #787c7e !important; /* Use normal text color during failure */
        }
        
        @keyframes failureCascade {
            0% { 
                background-color: transparent !important; 
                border-color: #d3d6da !important; 
                color: #1a1a1b !important; 
                border-width: 2px !important;
                box-shadow: none !important;
                animation: none !important;
                transform: scale(1) !important;
            }
            50% { 
                background-color: #e74c3c !important; 
                border-color: #e74c3c !important; 
                color: white !important; 
                transform: scale(1.1);
                border-width: 2px !important;
                box-shadow: none !important;
            }
            100% { 
                background-color: #e74c3c !important; 
                border-color: #e74c3c !important; 
                color: white !important; 
                transform: scale(1);
                border-width: 2px !important;
                box-shadow: none !important;
            }
        }
        
        /* Failed rung styling - turns entire rung red */
        .rung.failed {
            background-color: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c !important; /* Override any orange active border */
            box-shadow: none !important; /* Remove any orange glow */
            transition: all 0.3s ease;
        }
        
        .rung.failed .letter-box {
            background-color: #e74c3c !important;
            border-color: #e74c3c !important;
            color: white !important;
        }

        /* FINISH rung matches other completed rungs exactly - no special styling */

        .rung.climbing-animation {
            animation: climbGlow 0.8s ease-in-out;
            transform-origin: center;
        }

        .rung.loading-animation {
            animation: loadingGlow 0.8s ease-in-out;
            transform-origin: center;
        }

        .rung.mobile-loading-animation {
            animation: mobileLoadingGlow 0.4s ease-out;
        }

        .letter-box.cascade-fill {
            animation: cascadeFill 0.4s ease-out;
        }

        @keyframes climbGlow {
            0% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(106, 170, 100, 0.1);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 2px 8px rgba(106, 170, 100, 0.3);
                border-color: #6aaa64;
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(106, 170, 100, 0.1);
            }
        }

        @keyframes loadingGlow {
            0% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(106, 170, 100, 0.1);
                opacity: 0.3;
            }
            50% { 
                transform: scale(1.04);
                box-shadow: 0 3px 8px rgba(106, 170, 100, 0.6);
                border-color: #6aaa64;
                opacity: 1;
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(106, 170, 100, 0.1);
                opacity: 1;
            }
        }

        /* Fast mobile loading animation - matches chime timing */
        @keyframes mobileQuickSlideIn {
            0% { 
                transform: translateY(15px);
                opacity: 0;
            }
            100% { 
                transform: translateY(0px);
                opacity: 1;
            }
        }

        /* Dynamic mobile loading rungs - adjust to available viewport */
        .mobile-loading-rung {
            /* Height calculated dynamically in JavaScript */
            padding: 8px 16px !important;
            margin: 4px 0 !important;
            background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
            border: 2px solid var(--primary-green); /* Thicker border for better visibility */
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary-green);
        }

        /* Quick mobile animation */
        .mobile-loading-animation {
            animation: mobileQuickSlideIn 0.15s ease-out;
        }

        @keyframes cascadeFill {
            0% { 
                background-color: transparent;
                border-color: #d3d6da;
                color: #1a1a1b;
                transform: translateY(0);
            }
            30% { 
                background-color: #6aaa64 !important;
                border-color: #6aaa64 !important;
                color: white !important;
                transform: translateY(-4px);
                box-shadow: 0 3px 6px rgba(106, 170, 100, 0.4);
            }
            60% {
                transform: translateY(1px);
                box-shadow: 0 2px 4px rgba(106, 170, 100, 0.3);
            }
            100% { 
                background-color: #6aaa64 !important;
                border-color: #6aaa64 !important;
                color: white !important;
                transform: translateY(0);
                box-shadow: 0 1px 3px rgba(106, 170, 100, 0.2);
            }
        }

        .ladder.completion-celebrate {
            animation: ladderCelebrate 2s ease-in-out;
        }

        @keyframes ladderCelebrate {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.02); }
            60% { transform: scale(1.01); }
        }

        .rung.completed .letter-box {
            background: #6aaa64 !important;
            border-color: #6aaa64 !important;
            color: white;
        }

        .input-area {
            display: none;
        }

        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 14px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn-primary {
            background: #6aaa64;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5d9556;
        }

        .btn-secondary {
            background: #ff8c42;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e06829;
        }

        .btn-tertiary {
            background: #787c7e;
            color: white;
        }

        .btn-tertiary:hover:not(:disabled) {
            background: #666a6d;
        }

        .btn:disabled {
            background: #d3d6da;
            color: #787c7e;
            cursor: not-allowed;
        }

        .feedback {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: 500;
            display: none;
        }

        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback.hint {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .feedback.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reveal-confirmation {
            background: white;
            border: 2px solid #ff8c42;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 16px 0;
            display: none;
        }

        .reveal-confirmation.show {
            display: block;
        }

        .reveal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        .reveal-buttons .btn {
            flex: none;
            min-width: 80px;
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a1a1b;
            margin-bottom: 8px;
        }

        .results-subtitle {
            font-size: 1rem;
            color: #787c7e;
            margin-bottom: 24px;
        }

        .results-time {
            font-size: 3rem;
            font-weight: 700;
            color: #6aaa64;
            margin-bottom: 8px;
        }

        .results-message {
            font-size: 1.1rem;
            color: #1a1a1b;
            margin-bottom: 32px;
        }

        .share-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .share-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .share-text {
            background: #1da1f2;
            color: white;
        }

        .share-text:hover {
            background: #1a91da;
        }

        .share-copy {
            background: #6aaa64;
            color: white;
        }

        .share-copy:hover {
            background: #5d9556;
        }

        .play-again {
            background: #787c7e;
            color: white;
            margin-top: 16px;
            width: 100%;
        }

        .play-again:hover {
            background: #666a6d;
        }

        /* FINISH placeholder style */
        .mobile-keyboard.hide{display:none!important;}
        
        /* Loading outline keyframes for mobile */
        @keyframes loadingOutline{0%{border-color:#d3d6da;box-shadow:none;}100%{border-color:#6aaa64;box-shadow:0 0 6px rgba(106,170,100,.4);}}

        .letter-box.finish-placeholder {
            background-color: #d3d6da !important;
            border-color: #d3d6da !important;
            color: #787c7e !important;
        }
        
        /* Current position (first letter) styling */
        .letter-box.filled.current {
            background-color: white !important; /* White background for revealed letters */
            border-color: #ff8c42 !important; /* Orange border for current position */
            border-width: 2px !important; /* Same as default - no size change */
            box-shadow: 0 0 8px rgba(255, 140, 66, 0.3) !important;
            animation: pulse 1.5s infinite !important;
            color: #787c7e !important; /* Medium gray text for revealed letters */
        }
        /* Hint-revealed letters that are also filled & current should stay orange */
        .letter-box.hint-revealed.filled.current {
            color: #ff8c42 !important;
        }
        
        /* Time penalty popup styles */
        .time-penalty-popup {
            position: fixed;
            background-color: #e74c3c;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
            border: none;
        }
        
        .time-penalty-popup.fade-out {
            opacity: 0;
        }

        /* Hint popup styles - orange theme with centered text */
        .hint-popup {
            position: fixed;
            background-color: var(--primary-orange);
            color: white;
            padding: 24px 32px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 1.05rem;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
            text-align: center;
            border: none;
            box-shadow: 0 6px 24px rgba(255, 140, 66, 0.3);
            max-width: 320px;
            min-width: 280px;
            line-height: 1.5;
        }
        
        .hint-popup.fade-out {
            opacity: 0;
        }

        /* Countdown Page Styles */
        .countdown-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            max-width: 500px;
            margin: 30px auto 0; /* bring closer to header */
            padding: 0 20px 40px;
            min-height: calc(100vh - 120px);
        }
        
        .countdown-card {
            background: transparent;
            border: none;
            box-shadow: none;
            text-align: center;
        }
        
        .countdown-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            color: #787c7e;
            margin: 24px 0 0 0;
            text-align: center;
        }
        
        .countdown-timer {
            font-size: 3.5rem;
            font-weight: 600;
            color: var(--primary-orange);
            margin-bottom: 0;
            text-align: center;
            letter-spacing: -0.02em;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        /* Unified card style used by countdown and failure screens */
        .countdown-content .signup-card,
        .failure-screen-container .signup-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.04);
            text-align: center;
            margin-top: 60px;
            max-width: 500px; /* Match container width */
            width: 100%; /* Take full width of container */
            position: relative;
            align-self: center; /* Ensure centered alignment */
        }

        /* Override margin-top for failure screen only to fix positioning */
        .failure-screen-container .signup-card:first-child {
            margin-top: 0px; /* Remove large margin for first card only */
        }
        
        .failure-screen-container .signup-card:not(:first-child) {
            margin-top: 24px; /* Restore spacing between cards (matching home.html gap) */
        }

        .countdown-content .signup-title,
        .failure-screen-container .signup-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #6aaa64;
            margin-bottom: 8px;
        }

        .countdown-content .signup-description,
        .failure-screen-container .signup-description {
            font-size: 0.9rem;
            color: #787c7e;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .countdown-content .signup-buttons,
        .failure-screen-container .signup-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .countdown-content .signup-close,
        .failure-screen-container .signup-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #787c7e;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .countdown-content .signup-close:hover,
        .failure-screen-container .signup-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .countdown-content .signup-button,
        .failure-screen-container .signup-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .countdown-content .signup-button.primary,
        .failure-screen-container .signup-button.primary {
            background: #6aaa64;
            color: white;
        }
        
        .countdown-content .signup-button.primary:hover,
        .failure-screen-container .signup-button.primary:hover {
            background: #5a9054;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.3);
        }



        /* Mobile countdown styles */
        @media (max-width: 480px) {
            .countdown-content {
                margin-top: 0px; /* Match desktop countdown margin */
                padding: 0 16px 20px; /* Remove excessive top padding */
                min-height: calc(100vh - 80px);
            }
            
            .countdown-timer {
                font-size: 2.8rem;
            }
            
            .countdown-subtitle {
                font-size: 1rem;
                margin: 20px 0 0 0;
            }
            
            .testing-replay-button {
                padding: 14px 24px;
                font-size: 1rem;
            }
        }
        

        


        /* PWA Installation Card Styles (Mobile Only) */
        .pwa-install-card {
            display: block;
            animation-delay: 0.3s;
            background: white;
            color: #1a1a1b;
            border: 2px solid #6aaa64;
            box-shadow: 0 2px 8px rgba(106, 170, 100, 0.15);
            position: relative;
        }
        
        /* Allow JavaScript to hide PWA cards */
        .pwa-install-card.hidden {
            display: none !important;
        }
        
        .pwa-install-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #6aaa64;
            text-align: center;
        }
        
        .pwa-install-subtitle {
            font-size: 0.9rem;
            margin-bottom: 20px;
            color: #787c7e;
            text-align: center;
        }
        
        .pwa-install-steps {
            margin-bottom: 20px;
        }
        
        .pwa-step {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px 0;
            margin-left: 0px;
            justify-content: flex-start;
        }
        
        .pwa-step:last-child {
            margin-bottom: 0;
        }
        
        .pwa-step-icon {
            width: 28px;
            height: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pwa-step-icon svg {
            width: 28px;
            height: 28px;
            color: #6aaa64;
            stroke: currentColor;
        }
        
        .pwa-step-text {
            font-size: 0.9rem;
            color: #787c7e;
            flex: 1;
            text-align: left;
        }
        
        .highlight-green {
            color: #6aaa64;
            font-weight: 600;
        }
        
        .highlight-orange {
            color: #ff8c42;
            font-weight: 600;
        }
        
        .pwa-install-dismiss {
            background: var(--gray-50);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pwa-install-dismiss:hover {
            background: var(--gray-200);
            color: var(--gray-900);
            transform: translateY(-1px);
        }
        
        /* Android PWA Install Card Styles */
        .pwa-app-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .pwa-app-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .pwa-app-details {
            flex: 1;
        }
        
        .pwa-app-details .pwa-install-title {
            text-align: left;
            margin-bottom: 4px;
            font-size: 1.3rem;
        }
        
        .pwa-install-button {
            background: #6aaa64;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .pwa-install-button:hover {
            background: #5c9156;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.3);
        }
        
        .install-icon {
            width: 20px;
            height: 20px;
        }
        
        /* Failure PWA Card Orange Theme */
        .failure-pwa-card {
            animation-delay: 0.3s;
            background: white;
            border: 2px solid #ff8c42;
            box-shadow: 0 2px 8px rgba(255, 140, 66, 0.15);
            position: relative;
        }
        
        .failure-pwa-card .pwa-install-title {
            color: #ff8c42;
        }
        
        .failure-pwa-card .pwa-step-icon svg {
            color: #ff8c42;
        }
        
        .failure-pwa-card .pwa-step-text {
            color: #1a1a1b;
        }
        
        .failure-install-button {
            background: #ff8c42;
            color: white;
            border: none;
        }

        /* More Puzzles Signup Card Styles */
        .more-puzzles-signup-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #6aaa64;
            margin: 0 0 12px 0;
            text-align: center;
        }
        
        .more-puzzles-signup-description {
            font-size: 0.9rem;
            color: var(--gray-600);
            text-align: center;
            margin: 0 0 20px 0;
            line-height: 1.4;
        }
        
        .more-puzzles-signup-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .more-puzzles-signup-button {
            width: 100%;
            padding: 8px 20px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center content vertically */
            min-height: 44px;
        }
        
        .more-puzzles-signup-button.primary {
            background: var(--primary-green);
            color: white;
            box-shadow: 0 2px 8px rgba(106, 170, 100, 0.2);
        }
        
        .more-puzzles-signup-button.primary:hover {
            background: var(--primary-green-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.3);
        }
        
        .more-puzzles-signup-button.secondary {
            background: var(--gray-50);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }
        
        .more-puzzles-signup-button.secondary:hover {
            background: var(--gray-200);
            color: var(--gray-900);
            transform: translateY(-1px);
        }
        
        .signup-button-text {
            display: block;
            font-weight: 600;
            text-align: center;
            width: 100%;
        }
        
        .signup-button-subtitle {
            display: block;
            font-size: 0.85rem;
            font-weight: 400;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Card close button */
        .card-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #787c7e;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .card-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        /* Standard card spacing - matching original project spacing */
        .pwa-install-card {
            margin-bottom: 8px;
        }
        
        .more-puzzles-signup-card {
            margin-bottom: 8px;
        }
        
        /* Mobile-specific styling - wider cards and dynamic letter boxes */
        @media (max-width: 480px) {
            /* Set up proper mobile container layout */
            html, body {
                height: 100%;
            }
            .container {
                padding: 0;
                height: 100%;
                flex-direction: column;
                overflow-x: hidden;
                overflow-y: auto;
            }
            
            /* Cards completely fill screen width - ZERO margins */
            .card {
                padding: 24px;
                max-width: none;
                margin: 0; /* ZERO margin - edge to edge */
            }
            
            /* Rung optimization for mobile - ZERO side padding for full width */
            .rung {
                padding: 20px 0; /* NO side padding - completely edge to edge */
                border-radius: 8px;
                display: flex;
                flex-direction: column;
                justify-content: center; /* Center the word + hint unit */
                align-items: center;
                scroll-snap-align: center;
                /* Remove scroll-margin-top to eliminate gray space above first rung */
            }
            
            /* FINISH rung - center letters vertically when no hint */
            .rung.finish-rung {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
            }
            
            .rung.finish-rung .word-display {
                margin-bottom: 0; /* Remove margin since no hint below */
            }
            
            .word-display {
                gap: 2px;
                margin-bottom: 12px; /* Balanced space between letters and hint */
                justify-content: center; /* Center the letter boxes */
                display: flex;
                flex-wrap: wrap;
            }
            
            /* Dynamic letter box sizing - DRASTICALLY BIGGER to test screen usage */
            .letter-box {
                --available-width: calc(100vw - 32px); /* More padding for card edges and safety margin */
                --gap-space: calc(9 * 2px); /* 9 gaps between 10 letters at 2px each */
                --letter-space: calc(var(--available-width) - var(--gap-space));
                --letter-size: calc(var(--letter-space) / 10.5); /* Divide by 10.5 for extra space */
                
                /* Dynamic sizing with safety margin to prevent wrapping */
                width: clamp(22px, var(--letter-size), 50px) !important;
                height: clamp(22px, var(--letter-size), 50px) !important;
                font-size: clamp(0.7rem, calc(var(--letter-size) * 0.5), 1.8rem) !important;
                border-width: 2px; /* Keep original border thickness */
            }
            
            .word-hint {
                font-size: 1.1rem; /* Even bigger hint text */
                line-height: 1.4;
                color: #787c7e;
                text-align: center;
                font-weight: 500;
            }
            
            .completion-content {
                gap: 16px;
                padding: 120px 16px 160px 16px; /* Extra bottom padding for mobile browser chrome */
                overflow-y: auto;
                overflow-x: hidden; /* Prevent horizontal scrolling */
                max-height: none; /* Remove height constraint to prevent cutoff */
                min-height: calc(100vh - 80px); /* Ensure full viewport usage */
                align-items: center; /* Keep cards centered and width-stable */
                width: 100%; /* Force full width container */
            }
            
            /* Mobile styles for new failure container */
            .failure-content-container {
                gap: 16px;
                padding: 120px 16px 160px 16px; /* Extra bottom padding for mobile browser chrome */
                overflow-y: auto;
                overflow-x: hidden; /* Prevent horizontal scrolling */
                max-height: none; /* Remove height constraint to prevent cutoff */
                min-height: calc(100vh - 80px); /* Ensure full viewport usage */
                align-items: center; /* Keep cards centered and width-stable */
                width: 100%; /* Force full width container */
            }
            
            /* Override mobile card width constraints */
            .completion-content .card,
            .failure-content-container .card {
                width: 100%;
                max-width: calc(100vw - 32px); /* Full width minus padding */
                min-width: auto; /* Allow mobile to be narrower */
            }
            
            .completion-title,
            .failure-title {
                font-size: 1.5rem;
            }
            
            .completion-time,
            .failure-time {
                font-size: 2.5rem;
            }
            
            .failure-buttons,
            .signup-buttons {
                flex-direction: row;
                gap: 12px;
            }
            
            /* Keep completion buttons side by side on mobile */
            .completion-buttons {
                display: flex;
                flex-direction: row;
                gap: 12px;
            }
            
            .completion-button,
            .failure-button,
            .signup-button {
                width: 100%;
                min-width: auto;
            }
        }

        /* Mobile Keyboard Styles - hidden by default, shown on mobile */
        .mobile-keyboard {
            display: none;
            flex-direction: column;
            gap: 10px; /* Increased gap between rows for better spacing */
            padding: 16px 3px 28px 3px; /* Slightly more top padding */
            background: #f8f9fa;
            border-top: 1px solid #d3d6da;
            margin-top: auto;
            flex-shrink: 0; /* Prevent keyboard from shrinking */
            min-height: 210px; /* Increased height for larger gaps */
            width: calc(100vw - 6px); /* Full viewport width minus 6px total margin */
            box-sizing: border-box;
        }
        
        /* Mobile elements hidden by default */
        .mobile-game-area {
            display: none;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 5px; /* Increased gap for better touch accuracy */
        }

        .keyboard-key {
            background: #d3d6da;
            border: none;
            border-radius: 8px; /* Slightly more rounded like Apple */
            color: #1a1a1b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1; /* Keys expand to fill available space */
            font-family: inherit;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle depth like Apple */
            
            /* Improved dynamic sizing with better gap calculation */
            --available-keyboard-width: calc(100vw - 12px); /* Account for keyboard padding */
            --total-horizontal-gaps: calc(9 * 5px); /* 9 gaps at 5px each for 10-key row */
            --key-space: calc(var(--available-keyboard-width) - var(--total-horizontal-gaps));
            --key-width: calc(var(--key-space) / 10); /* Divide remaining space by 10 keys */
            width: clamp(26px, var(--key-width), 40px);
            height: clamp(42px, calc(var(--key-width) * 1.3), 58px);
            font-size: clamp(1.1rem, calc(var(--key-width) * 0.5), 1.5rem); /* Bigger letters */
        }

        .keyboard-key:active {
            transform: scale(0.95);
            background: #a8adb3;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); /* Pressed state shadow */
        }

        .keyboard-key.wide {
            flex: 1.5; /* Take up more space than regular keys */
            min-width: 58px; /* Adjusted for new spacing */
            max-width: 68px; /* Adjusted for new spacing */
            font-size: 1rem; /* Bigger letters for wide keys too */
        }

        .keyboard-key:disabled {
            background: #878a8c;
            color: #d3d6da;
            cursor: not-allowed;
        }

        /* Completion and Failure Page Styles */
        .completion-page,
        .failure-page {
            display: none;
            background-color: #fafafa;
        }
        
        /* Card styling - matches intro card exactly */
        .card {
            background: white;
            border: 1px solid #d3d6da;
            border-radius: 12px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            opacity: 0;
            transform: translateY(40px);
            animation: cardSlideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            flex-shrink: 0; /* Prevent collapse when siblings are dismissed */
        }
        
        /* Completion and Failure Card Styles */
        .completion-card, .failure-card {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Desktop-only: Fixed width to prevent layout shift when cards are dismissed */
        @media (min-width: 769px) {
            .completion-card, .failure-card {
                width: 500px !important;
                min-width: 500px;
            }
        }
        
        .completion-success {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-hover) 100%);
            color: white;
        }
        
        .failure-error {
            background: linear-gradient(135deg, var(--error-red) 0%, #c0392b 100%);
            color: white;
        }
        
        .completion-header, .failure-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .completion-title, .failure-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .completion-status, .failure-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .completion-details, .failure-details {
            margin-bottom: 20px;
        }
        
        .completion-stats, .failure-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        
        .completion-stats .stat-item, .failure-stats .stat-item {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .completion-stats .stat-value, .failure-stats .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .completion-stats .stat-label, .failure-stats .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .completion-actions, .failure-actions {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .completion-buttons, .failure-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        /* Desktop-only: Signup card width matching */
        @media (min-width: 769px) {
            .more-puzzles-signup-card {
                width: 500px !important; /* Match completion/failure card width */
                max-width: 500px;
                min-width: 500px;
            }
        }
        
        .card:nth-child(2) {
            animation-delay: 0.15s;
        }
        
        @keyframes cardSlideUp {
            0% {
                opacity: 0;
                transform: translateY(40px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result-theme {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
            font-weight: 500;
            font-style: italic;
        }
        
        .completion-time,
        .failure-time {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 32px;
            letter-spacing: -0.02em;
        }
        
        .completion-time {
            color: #6aaa64;
        }
        
        .failure-time {
            color: #e74c3c;
        }
        
        .completion-buttons .completion-button {
            background: white;
            color: #787c7e;
            border: 1px solid #d3d6da;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .completion-buttons .completion-button:hover {
            background: white;
            border-color: #6aaa64;
            color: #6aaa64;
        }
        
        .completion-button,
        .failure-button {
            padding: 8px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .completion-button:hover,
        .failure-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .completion-button.primary,
        .failure-button.primary {
            background: white;
            color: var(--primary-green);
            border-color: white;
        }
        
        .failure-button.primary {
            color: var(--error-red);
        }
        
        .completion-button.primary:hover,
        .failure-button.primary:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        /* CSS Subsection 10: PWA Installation & Signup Cards */
        
        /* Signup Card Styles */
        .signup-card {
            animation-delay: 0.15s;
        }
        
        .signup-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1b;
            margin-bottom: 8px;
        }
        
        .signup-text {
            font-size: 0.9rem;
            color: #787c7e;
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        .signup-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .signup-button {
            padding: 12px 24px;
            border: 1px solid #d3d6da;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            background: white;
            color: #1a1a1b;
        }
        
        .signup-button:hover {
            border-color: #6aaa64;
            color: #6aaa64;
        }
        
        .signup-button.primary {
            background: #6aaa64;
            color: white;
            border-color: #6aaa64;
        }
        
        .signup-button.primary:hover {
            background: #5d9556;
            border-color: #5d9556;
        }
        
        /* Auth Card Styles */
        .auth-card {
            animation-delay: 0.15s;
        }
        
        .auth-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1b;
            margin-bottom: 8px;
        }
        
        .auth-text {
            font-size: 0.9rem;
            color: #787c7e;
            margin-bottom: 24px;
            line-height: 1.4;
        }
        
        /* PWA Installation Card Styles */
        .pwa-install-card {
            display: block;
            animation-delay: 0.3s;
            background: white;
            color: #1a1a1b;
            border: 2px solid #6aaa64;
            box-shadow: 0 2px 8px rgba(106, 170, 100, 0.15);
            position: relative;
            margin-top: 20px; /* Add spacing between completion card and PWA card */
        }
        
        .pwa-install-card.hidden {
            display: none !important;
        }
        
        .pwa-install-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #6aaa64;
            text-align: center;
        }
        
        .pwa-install-subtitle {
            font-size: 0.9rem;
            margin-bottom: 20px;
            color: #787c7e;
            text-align: center;
        }
        
        .pwa-install-steps {
            margin-bottom: 20px;
        }
        
        .pwa-step {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px 0;
            margin-left: 0px;
            justify-content: flex-start;
        }
        
        .pwa-step:last-child {
            margin-bottom: 0;
        }
        
        .pwa-step-icon {
            width: 28px;
            height: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pwa-step-icon svg {
            width: 28px;
            height: 28px;
            color: #6aaa64;
            stroke: currentColor;
        }
        
        .pwa-step-text {
            font-size: 0.9rem;
            color: #787c7e;
            flex: 1;
            text-align: left;
        }
        
        .highlight-green {
            color: #6aaa64;
            font-weight: 600;
        }
        
        .highlight-orange {
            color: #ff8c42;
            font-weight: 600;
        }
        
        .pwa-install-dismiss {
            background: var(--gray-50);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pwa-install-dismiss:hover {
            background: var(--gray-200);
            color: var(--gray-900);
            transform: translateY(-1px);
        }
        
        /* Android PWA Install Card Styles */
        .pwa-app-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .pwa-app-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .pwa-app-details {
            flex: 1;
        }
        
        .pwa-app-details .pwa-install-title {
            text-align: left;
            margin-bottom: 4px;
            font-size: 1.3rem;
        }
        
        .pwa-install-button {
            background: #6aaa64;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 12px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .pwa-install-button:hover {
            background: #5c9156;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.3);
        }
        
        .install-icon {
            width: 20px;
            height: 20px;
        }
        
        .card-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            color: #787c7e;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .card-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        /* More Puzzles Signup Card Styles */
        .more-puzzles-signup-card {
            margin-top: 20px; /* Add spacing between PWA and signup cards */
            animation-delay: 0.4s;
            background: white;
            border: 1px solid var(--gray-200);
            margin-bottom: 20px;
            position: relative;
        }
        
        /* Failure PWA Card Orange Theme */
        .failure-pwa-card {
            animation-delay: 0.3s;
            background: white;
            color: #1a1a1b;
            border: 2px solid #ff8c42;
            box-shadow: 0 2px 8px rgba(255, 140, 66, 0.15);
            position: relative;
        }
        
        .failure-pwa-card .pwa-install-title {
            color: #ff8c42;
        }
        
        .failure-pwa-card .pwa-step-icon svg {
            color: #ff8c42;
        }
        
        .failure-pwa-card .pwa-step-text {
            color: #1a1a1b;
        }
        
        .failure-install-button {
            background: #ff8c42;
            color: white;
            border: none;
        }

        /* Mobile Elements - Hidden by default */
        .mobile-header {
            display: none;
        }
        
        .mobile-game-area {
            display: none;
        }
        
        .mobile-keyboard {
            display: none;
        }

        /* Mobile-specific styles */
        @media (max-width: 480px) {
            /* Hide main header on mobile when in game mode */
            .mobile-game-mode .header {
                display: none !important;
            }
            
            /* Show mobile header on mobile when in game mode */
            .mobile-game-mode .mobile-header {
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                padding: 12px 16px 8px;
                background: #fafafa;
                border-bottom: 1px solid #d3d6da;
                flex-shrink: 0;
                z-index: 1000;
                transition: opacity 0.4s ease-in;
            }
            
            /* Hide desktop stats on mobile during game */
            .mobile-game-mode .desktop-stats {
                display: none !important;
            }
            
            /* Hide desktop game area on mobile */
            .mobile-game-mode .game-area {
                display: none !important;
            }
            
            /* Show mobile game area on mobile - start from top of screen */
            .mobile-game-mode .mobile-game-area {
                display: flex !important;
                flex: 1;
                overflow-y: auto;
                overflow-x: visible;
                padding: 0; /* ZERO padding - completely fill screen */
                margin: 0; /* ZERO margin - start from very top */
                flex-direction: column;
                min-height: 0; /* Important for flex child overflow */
            }
            
            /* Show mobile keyboard on mobile */
            .mobile-game-mode .mobile-keyboard {
                display: flex !important;
                position: fixed;
                bottom: calc(env(safe-area-inset-bottom, 0) - 23px);
                left: 3px;
                right: 3px;
                width: calc(100vw - 6px);
                z-index: 9999;
                opacity: 1;
                transition: opacity 0.4s ease-in;
            }
            
            /* Mobile header stats styling */
            .mobile-header .stats {
                display: flex !important;
                gap: 24px;
                margin-bottom: 0;
                justify-content: center;
            }
            
            .mobile-header .stat-value {
                font-size: 1.2rem;
            }
            
            .mobile-header .stat-label {
                font-size: 0.6rem;
            }
            
            /* Proper container padding in mobile-game-mode for header + 4px gap */
            .mobile-game-mode .container {
                padding-top: 66px !important; /* Mobile header height (51px) + 4px gap */
            }
            
            /* Mobile ladder viewport - scrollable container */
            .mobile-ladder-viewport {
                flex: 1;
                overflow-y: auto;
                overflow-x: visible;
                padding-bottom: 20px; /* Match old version exactly */
                margin: 0;
                max-height: calc(100vh - 115px - 210px); /* Back to old version height */
                scroll-behavior: smooth;
            }
            
            /* Mobile ladder styling - match old version exactly */
            .mobile-ladder {
                display: flex;
                flex-direction: column;
                gap: 12px;
                padding: 12px 0 20px 0; /* Match old version exactly */
                margin: 0;
            }
            
            /* Smaller letter boxes on mobile */
            .letter-box {
                width: 26px;
                height: 26px;
                font-size: 0.9rem;
            }
            
            /* Mobile button adjustments */
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                min-width: auto;
            }
        }

        /* Completion and Failure Card Styles */
        .completion-content {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            transition: opacity 0.4s ease-out;
        }

        /* New Failure Content Container - Properly Centered Like Header */
        .failure-content-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            transition: opacity 0.4s ease-out;
        }

        /* Test Card Styles - Properly Centered Like Header */
        .test-card-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        /* Failure Screen Container - Match Countdown Container Styling */
        .failure-screen-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 5px 20px 40px 20px; /* Much closer to header */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px; /* Match home.html spacing */
            transition: opacity 0.4s ease-out;
            overflow-y: auto;
        }

        /* Failure cards – restore old visual language without moving layout */
        #failure-content .signup-card {
            border: 1px solid #d3d6da;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            position: relative;
        }

        /* Full red main card */
        #failure-content .signup-card.card-failed {
            background: linear-gradient(135deg, var(--error-red) 0%, #c0392b 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.12);
        }

        #failure-content .card-failed { 
            padding: 32px 28px; 
            min-height: 280px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between; /* Distribute content evenly */
        }
        #failure-content .card-failed .signup-title { 
            color: #fff; 
            font-weight: 700; 
            margin: 0; 
            font-size: 1.5rem; 
            flex-shrink: 0; /* Keep at top */
        }
        #failure-content .card-failed .signup-description { display:none; }
        #failure-content .failure-time { 
            font-size: 3.0rem; 
            font-weight: 700; 
            letter-spacing: -0.02em; 
            margin: 0; 
            color: #fff; 
            flex: 1; /* Take up middle space */
            display: flex;
            align-items: center; /* Center vertically in its space */
        }

        /* Button rows – desktop horizontal, mobile vertical */
        #failure-content .signup-buttons { 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            flex-direction: row; 
            flex-shrink: 0; /* Keep at bottom */
        }
        @media (max-width: 480px){ 
            /* Fix mobile failure screen scrolling - single scroll area */
            #failure-content {
                /* Remove nested overflow to prevent dual scrolling */
                overflow-y: visible !important; /* Remove inner scroll context */
                min-height: auto !important; /* Don't force viewport height */
                touch-action: pan-y !important;
                padding-bottom: 120px !important; /* Extra bottom padding for mobile browser UI */
            }
            
            #failure-content.failure-screen-container {
                /* Remove nested overflow - let outer container handle all scrolling */
                overflow-y: visible !important; /* Critical: remove inner scroll */
                min-height: auto !important; /* Don't compete with outer container */
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 120px !important; /* Extra bottom padding for mobile browser UI */
            }
            
            #failure-content .signup-buttons { 
                flex-direction: row !important; 
                gap: 8px; /* Reduce gap for mobile */
            }
            
            /* Make buttons smaller on mobile for better fit */
            #failure-content .signup-button {
                padding: 10px 20px !important;
                font-size: 0.85rem !important;
                min-width: 120px !important;
            }
        }

        #failure-content .signup-button { padding: 12px 24px; border-radius: 12px; font-weight: 700; border: none; font-size: 0.95rem; transition: transform .2s ease, box-shadow .2s ease, background .2s ease; min-width: 140px; }
        #failure-content .card-failed .signup-button.primary { background: #fff; color: var(--error-red); }
        #failure-content .card-failed .signup-button.primary:hover { background: rgba(255,255,255,.9); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.15); }

        /* Secondary buttons */
        #failure-content .signup-button:not(.primary) { background: #d3d6da; color: #565656; }
        #failure-content .signup-button:not(.primary):hover { background: #c8ccd1; transform: translateY(-1px); }

        /* Orange accent title for PWA card */
        #failure-content .signup-card:nth-of-type(2) .signup-title { color: var(--primary-orange); }

        /* Completion screen styling - green theme */
        #completion-content .signup-card.card-completed {
            background: linear-gradient(135deg, var(--primary-green) 0%, #5d9556 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 20px rgba(106, 170, 100, 0.12);
            padding: 32px 28px; 
            min-height: 280px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: space-between;
        }
        
        #completion-content .card-completed .signup-title { 
            color: #fff; 
            font-weight: 700; 
            margin: 0; 
            font-size: 1.5rem; 
            flex-shrink: 0;
        }
        
                #completion-content .completion-theme {
            font-size: 1.0rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
            margin: 16px 0 0 0;
            text-align: center;
            flex-shrink: 0;
        }
        
        #completion-content .completion-time {
            font-size: 3.0rem; 
            font-weight: 700; 
            letter-spacing: -0.02em; 
            margin: 0; 
            color: #fff; 
            flex: 1; 
            display: flex;
            align-items: center; 
            justify-content: center;
        }
        
        #completion-content .signup-button { 
            padding: 12px 32px; 
            border-radius: 12px; 
            font-weight: 600; 
            border: none; 
            font-size: 0.95rem; 
            transition: all 0.2s; 
            min-width: 160px;
        }
        
        #completion-content .card-completed .signup-button.primary { 
            background: #fff; 
            color: var(--primary-green); 
        }
        
        #completion-content .card-completed .signup-button.primary:hover { 
            background: rgba(255,255,255,.9); 
            transform: translateY(-1px); 
            box-shadow: 0 4px 12px rgba(0,0,0,.15); 
        }
        
        /* Completion screen buttons - side by side like failure screen */
        #completion-content .signup-buttons { 
            display: flex; 
            gap: 12px; 
            justify-content: center; 
            flex-direction: row; 
            flex-shrink: 0; 
        }
        /* Mobile-specific completion screen fixes */
        @media (max-width: 480px) {
            /* Fix mobile touch and scrolling - single scroll area */
            #completion-content {
                /* Remove nested overflow to prevent dual scrolling */
                overflow-y: visible !important; /* Remove inner scroll context */
                min-height: auto !important; /* Don't force viewport height */
                touch-action: pan-y !important; /* Allow vertical scrolling */
                padding-bottom: 120px !important; /* Extra bottom padding for mobile browser UI */
            }
            
            /* Ensure only outer container handles scrolling */
            #completion-content.failure-screen-container {
                /* Remove nested overflow - let outer container handle all scrolling */
                overflow-y: visible !important; /* Critical: remove inner scroll */
                min-height: auto !important; /* Don't compete with outer container */
                -webkit-overflow-scrolling: touch !important;
                padding-bottom: 120px !important; /* Extra bottom padding for mobile browser UI */
            }
            
            /* Fix theme spacing - move closer to title */
            #completion-content .completion-theme {
                margin: 8px 0 0 0 !important; /* Reduce from 16px to 8px */
            }
            
            /* Add proper spacing around time */
            #completion-content .completion-time {
                margin: 20px 0 !important; /* Add space above and below time */
            }
            
            /* Keep buttons side-by-side on mobile */
            #completion-content .signup-buttons { 
                flex-direction: row !important; 
                gap: 8px; /* Reduce gap for mobile */
            }
            
            /* Make buttons wider on mobile so text fits on one line */
            #completion-content .signup-button {
                padding: 10px 24px !important;
                font-size: 0.85rem !important;
                min-width: 130px !important; /* Increased from 110px to fit "Next Puzzle" */
                white-space: nowrap; /* Prevent text wrapping */
                touch-action: manipulation !important; /* Improve touch responsiveness */
            }
        }

        /* Android PWA card: replace icons with orange checkmarks */
        #failure-android-pwa-install-card .pwa-benefits { display: flex; flex-direction: column; gap: 8px; margin: 14px 0; }
        #failure-android-pwa-install-card .pwa-benefit { position: relative; padding-left: 22px; color: var(--gray-700); font-size: 0.95rem; }
        #failure-android-pwa-install-card .pwa-benefit::before { content: '✓'; position: absolute; left: 0; top: 0; color: var(--primary-orange); font-weight: 800; }



        /* Green highlight for completion screen PWA instructions */
        .highlight-green { color: var(--primary-green); font-weight: 600; }

        /* Completion PWA card styling - green theme */
        .completion-pwa-card { 
            border: 2px solid var(--primary-green) !important; 
            margin-bottom: -2px !important; /* Reduce bottom margin by 10px (from 8px to -2px) */
        }
        .completion-pwa-card .pwa-install-title { color: var(--primary-green) !important; }

        .test-header {
            text-align: center;
            margin-bottom: 16px; /* More compact */
        }

        .test-title {
            font-size: 1.3rem; /* Match countdown signup title */
            font-weight: 600;
            color: var(--gray-900);
            margin: 0 0 8px 0; /* Match countdown title margin */
        }

        .test-details {
            margin: 20px 0;
            color: var(--gray-600); /* Match countdown description color */
            line-height: 1.4; /* Match countdown line height */
        }

        .test-details p {
            font-size: 0.9rem; /* Match countdown description size */
            margin: 10px 0;
        }

        .test-actions {
            display: flex;
            flex-direction: column; /* Match countdown button layout */
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .test-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px; /* Match countdown button radius */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s; /* Match countdown transition */
            font-size: 0.9rem; /* Match countdown button size */
        }

        .test-button.primary {
            background: var(--primary-green);
            color: white;
        }

        .test-button.primary:hover {
            background: var(--primary-green-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(106, 170, 100, 0.3); /* Match countdown button shadow */
        }

        /* Failure stats styling within test card */
        .failure-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 15px 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-900);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 4px;
        }

        /* PWA Benefits styling */
        .pwa-benefits {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 15px 0;
        }

        .pwa-benefit {
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        /* Secondary button styling - Match countdown styling */
        .test-button.secondary {
            background: var(--gray-200);
            color: var(--gray-600);
            border: none;
        }

        .test-button.secondary:hover {
            background: var(--gray-400);
            transform: translateY(-1px);
        }

        /* Main failure card with red border - Match home.html style */
        .failure-main-card {
            border: 2px solid var(--error-red) !important;
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.12) !important; /* Match home.html shadow depth */
        }
        
        .card {
            background: white;
            border: 1px solid #d3d6da;
            border-radius: 12px;
            padding: 32px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        
        .completion-success {
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--primary-green-hover) 100%);
            color: white;
        }
        
        .failure-error {
            background: linear-gradient(135deg, var(--error-red) 0%, #c0392b 100%);
            color: white;
        }
        
        .completion-header, .failure-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }
        
        .completion-title, .failure-title {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .completion-details, .failure-details {
            margin-bottom: 20px;
        }
        
        .result-theme {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 16px;
            font-weight: 500;
            font-style: italic;
        }
        
        .completion-stats, .failure-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        
        .completion-stats .stat-item, .failure-stats .stat-item {
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .completion-stats .stat-value, .failure-stats .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }
        
        .completion-stats .stat-label, .failure-stats .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .completion-buttons, .failure-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .completion-button, .failure-button {
            padding: 8px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .completion-button:hover, .failure-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .completion-button.primary, .failure-button.primary {
            background: white;
            color: var(--primary-green);
            border: none;
            font-weight: 700;
            margin-top: 8px;
            width: 100%;
            grid-column: 1 / -1;
        }
        
        .failure-button.primary {
            color: var(--error-red);
        }
        
        .completion-button.primary:hover, .failure-button.primary:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--gray-50);
            z-index: 1000;
            text-align: center;
            padding: 20px 20px 30px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
            color: #1a1a1b;
        }

        .date-info {
            font-size: 0.8rem;
            color: #787c7e;
        }
        
        .container {
            padding-top: 160px; /* Space for fixed header - mobile optimized */
        }
        
        .title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.2em;
            margin-bottom: 8px;
            color: var(--gray-900);
        }
        
        .date-info {
            font-size: 0.8rem;
            color: var(--gray-600);
        }
        
        .policy-content {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin: 40px 0;
            line-height: 1.6;
        }
        
        .policy-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .policy-content h2 {
            color: var(--gray-900);
            font-size: 1.3rem;
            font-weight: 600;
            margin: 30px 0 15px 0;
        }
        
        .policy-content h3 {
            color: var(--gray-700);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 20px 0 10px 0;
        }
        
        .policy-content p {
            margin-bottom: 15px;
            color: var(--gray-600);
        }
        
        .policy-content ul, .policy-content ol {
            margin: 15px 0 15px 30px;
            color: var(--gray-600);
        }
        
        .policy-content li {
            margin-bottom: 8px;
        }
        
        .policy-content strong {
            color: var(--gray-900);
        }
        
        .last-updated {
            text-align: center;
            color: var(--gray-400);
            font-size: 0.9rem;
            margin-top: 30px;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 160px 15px 20px 15px;
            }
            
            .policy-content {
                padding: 25px;
                margin: 20px 0;
            }
            
            .policy-title {
                font-size: 1.5rem;
            }
            
            .title {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>

    
    
    
    <div class="container">
        <header class="header">
            <div class="header-content">
                <h1 class="title">LADDER</h1>
                <p class="date-info" id="privacy-date-display">Loading...</p>
        </div>
        </header>

        <!-- Landing Page Content -->
        <div class="landing-content" id="landing-content">
            <div class="instruction-logo">
                <img src="./assets/icons/ladder_transparent.png" alt="Ladder Word Game - Daily Word Chain Puzzle" class="ladder-icon">
            </div>



            <button class="play-button" onclick="showGameContent()">Play</button>
            <p class="week-difficulty-text">Daily puzzle gets more challenging throughout the week</p>
    </div>

        <!-- Game Content (initially hidden) -->
        <div class="game-content" id="game-content" style="display: none;">
            <!-- Desktop Stats (hidden on mobile) -->
            <div class="stats desktop-stats">
            <div class="stat timer">
                <div class="stat-value" id="timer">0:00</div>
                <div class="stat-label">Time</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="hints-remaining">3</div>
                <div class="stat-label">Hints</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="tries-left">3</div>
                <div class="stat-label">Tries</div>
            </div>
        </div>

            <!-- Mobile Header (only shown on mobile during game) -->
            <div class="mobile-header" id="mobile-header" style="display: none;">
            <div class="stats">
                <div class="stat timer">
                    <div class="stat-value" id="mobile-timer">0:00</div>
                    <div class="stat-label">Time</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="mobile-hints-remaining">3</div>
                    <div class="stat-label">Hints</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="mobile-tries-left">3</div>
                    <div class="stat-label">Tries</div>
                </div>
            </div>
        </div>

            <div class="game-area">
                <div class="ladder" id="ladder">
                    <!-- Hardcoded puzzle from index_old - correct order: start at top, work down to FINISH -->
                    
                    <div class="rung active">
                        <div class="word-display">
                            <div class="letter-box filled hint-revealed">B</div>
                            <div class="letter-box current interactive">O</div>
                            <div class="letter-box interactive">O</div>
                            <div class="letter-box interactive">K</div>
                        </div>
                        <div class="word-hint">Reading material</div>
                    </div>
                    
                    <div class="rung completed">
                        <div class="word-display">
                            <div class="letter-box filled">L</div>
                            <div class="letter-box filled">I</div>
                            <div class="letter-box filled">B</div>
                            <div class="letter-box filled">R</div>
                            <div class="letter-box filled">A</div>
                            <div class="letter-box filled">R</div>
                            <div class="letter-box filled">Y</div>
                        </div>
                        <div class="word-hint">Quiet sanctuary</div>
                    </div>
                    
                    <div class="rung completed">
                        <div class="word-display">
                            <div class="letter-box filled">S</div>
                            <div class="letter-box filled">I</div>
                            <div class="letter-box filled">L</div>
                            <div class="letter-box filled">E</div>
                            <div class="letter-box filled">N</div>
                            <div class="letter-box filled">C</div>
                            <div class="letter-box filled">E</div>
                        </div>
                        <div class="word-hint">No sound</div>
                    </div>
                    
                    <div class="rung">
                        <div class="word-display">
                            <div class="letter-box filled hint-revealed">M</div>
                            <div class="letter-box">E</div>
                            <div class="letter-box">D</div>
                            <div class="letter-box">I</div>
                            <div class="letter-box">T</div>
                            <div class="letter-box">A</div>
                            <div class="letter-box">T</div>
                            <div class="letter-box">I</div>
                            <div class="letter-box">O</div>
                            <div class="letter-box">N</div>
                        </div>
                        <div class="word-hint">Mindful calm</div>
                    </div>
                    
                    <div class="rung">
                        <div class="word-display">
                            <div class="letter-box">P</div>
                            <div class="letter-box">E</div>
                            <div class="letter-box">A</div>
                            <div class="letter-box">C</div>
                            <div class="letter-box filled hint-revealed">E</div>
                        </div>
                        <div class="word-hint">Inner calm</div>
                    </div>
                    
                    <div class="rung finish-rung">
                        <div class="word-display">
                            <div class="letter-box filled finish-placeholder">F</div>
                            <div class="letter-box filled finish-placeholder">I</div>
                            <div class="letter-box filled finish-placeholder">N</div>
                            <div class="letter-box filled finish-placeholder">I</div>
                            <div class="letter-box filled finish-placeholder">S</div>
                            <div class="letter-box filled finish-placeholder">H</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Game Area (hidden on desktop, shown on mobile) -->
        <div class="mobile-game-area">
            <div class="mobile-ladder-viewport">
                    <div class="mobile-ladder" id="mobile-ladder">
                        <!-- Same hardcoded puzzle content as desktop for testing -->
                        
                        <div class="rung active">
                            <div class="word-display">
                                <div class="letter-box filled hint-revealed">B</div>
                                <div class="letter-box current interactive">O</div>
                                <div class="letter-box interactive">O</div>
                                <div class="letter-box interactive">K</div>
                            </div>
                            <div class="word-hint">Reading material</div>
                        </div>
                        
                        <div class="rung completed">
                            <div class="word-display">
                                <div class="letter-box filled">L</div>
                                <div class="letter-box filled">I</div>
                                <div class="letter-box filled">B</div>
                                <div class="letter-box filled">R</div>
                                <div class="letter-box filled">A</div>
                                <div class="letter-box filled">R</div>
                                <div class="letter-box filled">Y</div>
                            </div>
                            <div class="word-hint">Quiet sanctuary</div>
                        </div>
                        
                        <div class="rung completed">
                            <div class="word-display">
                                <div class="letter-box filled">S</div>
                                <div class="letter-box filled">I</div>
                                <div class="letter-box filled">L</div>
                                <div class="letter-box filled">E</div>
                                <div class="letter-box filled">N</div>
                                <div class="letter-box filled">C</div>
                                <div class="letter-box filled">E</div>
                            </div>
                            <div class="word-hint">No sound</div>
                        </div>
                        
                        <div class="rung">
                            <div class="word-display">
                                <div class="letter-box filled hint-revealed">M</div>
                                <div class="letter-box">E</div>
                                <div class="letter-box">D</div>
                                <div class="letter-box">I</div>
                                <div class="letter-box">T</div>
                                <div class="letter-box">A</div>
                                <div class="letter-box">T</div>
                                <div class="letter-box">I</div>
                                <div class="letter-box">O</div>
                                <div class="letter-box">N</div>
                            </div>
                            <div class="word-hint">Mindful calm</div>
                        </div>
                        
                        <div class="rung">
                            <div class="word-display">
                                <div class="letter-box">P</div>
                                <div class="letter-box">E</div>
                                <div class="letter-box">A</div>
                                <div class="letter-box">C</div>
                                <div class="letter-box filled hint-revealed">E</div>
                            </div>
                            <div class="word-hint">Inner calm</div>
                        </div>
                        
                        <div class="rung finish-rung">
                            <div class="word-display">
                                <div class="letter-box filled finish-placeholder">F</div>
                                <div class="letter-box filled finish-placeholder">I</div>
                                <div class="letter-box filled finish-placeholder">N</div>
                                <div class="letter-box filled finish-placeholder">I</div>
                                <div class="letter-box filled finish-placeholder">S</div>
                                <div class="letter-box filled finish-placeholder">H</div>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="feedback" id="mobile-feedback"></div>
        </div>

            <!-- Mobile Keyboard (hidden on desktop, shown on mobile) -->
        <div class="mobile-keyboard" id="mobile-keyboard">
            <div class="keyboard-row">
                <button class="keyboard-key" data-key="Q">Q</button>
                <button class="keyboard-key" data-key="W">W</button>
                <button class="keyboard-key" data-key="E">E</button>
                <button class="keyboard-key" data-key="R">R</button>
                <button class="keyboard-key" data-key="T">T</button>
                <button class="keyboard-key" data-key="Y">Y</button>
                <button class="keyboard-key" data-key="U">U</button>
                <button class="keyboard-key" data-key="I">I</button>
                <button class="keyboard-key" data-key="O">O</button>
                <button class="keyboard-key" data-key="P">P</button>
            </div>
            <div class="keyboard-row">
                <button class="keyboard-key" data-key="A">A</button>
                <button class="keyboard-key" data-key="S">S</button>
                <button class="keyboard-key" data-key="D">D</button>
                <button class="keyboard-key" data-key="F">F</button>
                <button class="keyboard-key" data-key="G">G</button>
                <button class="keyboard-key" data-key="H">H</button>
                <button class="keyboard-key" data-key="J">J</button>
                <button class="keyboard-key" data-key="K">K</button>
                <button class="keyboard-key" data-key="L">L</button>
            </div>
            <div class="keyboard-row">
                <button class="keyboard-key wide" data-key="HINT">HINT</button>
                <button class="keyboard-key" data-key="Z">Z</button>
                <button class="keyboard-key" data-key="X">X</button>
                <button class="keyboard-key" data-key="C">C</button>
                <button class="keyboard-key" data-key="V">V</button>
                <button class="keyboard-key" data-key="B">B</button>
                <button class="keyboard-key" data-key="N">N</button>
                <button class="keyboard-key" data-key="M">M</button>
                <button class="keyboard-key wide" data-key="BACKSPACE">⌫</button>
            </div>
        </div>


    </div>

        <!-- Completion Screen Content (initially hidden) -->
        <div class="failure-screen-container" id="completion-content" style="display: none;">
            <!-- Main Completion Card using unified signup-card styling (full green) -->
            <div class="signup-card card-completed">
                <h3 class="signup-title">Puzzle Complete!</h3>
                <div class="completion-theme" id="completion-theme">Theme: Loading...</div>
                <div class="completion-time" id="completion-time">02:34</div>
                <div class="signup-buttons">
                    <button class="signup-button primary" id="completion-share" onclick="shareCompletion()">Share</button>
                    <button class="signup-button primary" id="completion-next" onclick="showCountdownContent()">Next Puzzle</button>
                </div>
            </div>
            
            <!-- PWA Install Card (green theme with clean icons) -->
            <div class="pwa-install-card signup-card completion-pwa-card" id="completion-pwa-install-card" style="display:none;">
                <h3 class="pwa-install-title signup-title">Get the App</h3>
                <div class="pwa-install-steps">
                    <div class="pwa-step">
                        <div class="pwa-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="11" width="18" height="10" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 11V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 7L12 3L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="pwa-step-text">Tap the <span class="highlight-green">Share button</span> in your browser</div>
                    </div>
                    <div class="pwa-step">
                        <div class="pwa-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 8V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="pwa-step-text">Select <span class="highlight-green">"Add to Home Screen"</span></div>
                    </div>
                </div>
                <button class="signup-close" onclick="dismissCompletionPWACard(this)">×</button>
            </div>

            <!-- Want More Puzzles Signup Card -->
            <div class="signup-card">
                <h3 class="signup-title">Want more puzzles?</h3>
                <p class="signup-description">Create an account to unlock more puzzles and track your daily stats!</p>
                <button class="signup-close" onclick="this.closest('.signup-card').style.opacity='0.5'; setTimeout(() => this.closest('.signup-card').style.display='none', 300)">×</button>
                <div class="signup-buttons">
                    <button class="signup-button primary" onclick="window.location.href='./signup.html'">Sign Up</button>
                </div>
            </div>
        </div>

        <!-- Failure Screen with Multiple Cards -->
        <div class="failure-screen-container" id="failure-content" style="display: none;">
            <!-- Main Failure Card using unified signup-card styling (full red) -->
            <div class="signup-card card-failed">
                <h3 class="signup-title">Puzzle Incomplete</h3>
                <div class="failure-time" id="failure-time">00:00</div>
                <div class="signup-buttons">
                    <button class="signup-button primary" id="failure-try-again" onclick="retryGame()">Try Again</button>
                    <button class="signup-button primary" id="failure-countdown-button" onclick="showCountdownContent()">Next Puzzle</button>
                </div>
            </div>

            <!-- PWA Install Card -->
            <div class="signup-card" id="failure-android-pwa-install-card" style="display:none;">
                <h3 class="signup-title">Get the App</h3>
                <p class="signup-description">Install LADDER for faster loading and notifications.</p>
                <div class="pwa-benefits">
                    <span class="pwa-benefit">📱 Full screen experience</span>
                    <span class="pwa-benefit">⚡ Faster loading</span>
                    <span class="pwa-benefit">🔔 Daily notifications</span>
                </div>
                <div class="signup-buttons">
                    <button class="signup-button primary" id="failure-pwa-install-btn" onclick="installPWA()">Install App</button>
                    <button class="signup-button" id="failure-pwa-dismiss" style="background:#d3d6da;color:#565656;" onclick="dismissFailurePWACard(this)">Maybe Later</button>
                </div>
            </div>

            <!-- iOS PWA Instruction Card (orange theme) -->
            <div class="pwa-install-card signup-card failure-pwa-card" id="failure-pwa-install-card" style="display:none;">
                <h3 class="pwa-install-title signup-title">Get the App</h3>
                <div class="pwa-install-steps">
                    <div class="pwa-step">
                        <div class="pwa-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="11" width="18" height="10" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 11V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 7L12 3L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="pwa-step-text">Tap the <span class="highlight-orange">Share button</span> in your browser</div>
                    </div>
                    <div class="pwa-step">
                        <div class="pwa-step-icon">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 16L12 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 12L12 16L16 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M20 16V20C20 20.5304 19.7893 21.0391 19.4142 21.4142C19.0391 21.7893 18.5304 22 18 22H6C5.46957 22 4.96086 21.7893 4.58579 21.4142C4.21071 21.0391 4 20.5304 4 20V16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="pwa-step-text">Scroll down and tap "<span class="highlight-orange">Add to Home Screen</span>"</div>
                    </div>
                </div>
                <button class="signup-close card-close" onclick="dismissFailurePWACard(this)">×</button>
                <div class="signup-buttons"><button class="signup-button" onclick="dismissFailurePWACard(this)" style="background:#d3d6da;color:#565656;">Maybe Later</button></div>
            </div>

            <!-- More Puzzles Card -->
            <div class="signup-card">
                <h3 class="signup-title">Want more puzzles?</h3>
                <p class="signup-description">Create an account to unlock more puzzles and track your daily stats!</p>
                <button class="signup-close" onclick="this.closest('.signup-card').style.opacity='0.5'; setTimeout(() => this.closest('.signup-card').style.display='none', 300)">×</button>
                <div class="signup-buttons">
                    <button class="signup-button primary" onclick="window.location.href='./signup.html'">Sign Up</button>
                </div>
            </div>
        </div>



        <!-- Countdown Content (initially hidden) -->
        <div class="countdown-content" id="countdown-content" style="display: none;">
            <div class="instruction-logo">
                <img src="./assets/icons/ladder-trans-orange.png" alt="Ladder" class="ladder-icon">
            </div>
            <div class="countdown-card">
                <div class="countdown-timer" id="countdown-timer">00:00:00</div>
            </div>
            

            
            <!-- Signup card for non-authenticated users -->
            <div class="signup-card" id="countdown-signup-card" style="display: none;">
                <button class="signup-close" onclick="this.closest('.signup-card').style.opacity='0.5'; setTimeout(() => this.closest('.signup-card').style.display='none', 300)">×</button>
                <h3 class="signup-title">Want more puzzles?</h3>
                <p class="signup-description">Create an account to unlock more puzzles and track your daily stats!</p>
                <div class="signup-buttons">
                    <button class="signup-button primary" onclick="window.location.href='./signup.html'">Sign Up</button>
                </div>
            </div>
            

        </div>
        
    </div>

    <!-- External Libraries -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Application Modules -->
    <script type="module">
        // TESTING MODE - Set to true to enable replay functionality
        window.TESTING_MODE = true; // Temporarily enabled for Phase 1 testing
        
        // Enhanced puzzle parameter detection for multi-source support
        window.puzzleParams = {
            type: new URLSearchParams(window.location.search).get('type') || 'daily',
            packId: new URLSearchParams(window.location.search).get('pack_id'),
            puzzleId: new URLSearchParams(window.location.search).get('puzzle_id'),
            date: new URLSearchParams(window.location.search).get('date')
        };
        console.log('🎯 Puzzle parameters detected:', window.puzzleParams);
        
        // Log current URL for debugging (works on both localhost and ladder.game)
        console.log('📍 Current URL:', window.location.href);
        console.log('🔗 Search params:', window.location.search);
        console.log('🌐 Domain:', window.location.hostname);
        
        // Verify URL parameter detection works across domains
        if (window.location.search) {
            console.log('✅ URL parameters found and parsed successfully');
        } else {
            console.log('ℹ️ No URL parameters (normal for root page visits)');
        }
        
        // Initialize Supabase client and set it globally for modules
        import { supabaseConfig, setSupabaseClient } from './config/supabase-config.js';
        import { initializePWA } from './assets/js/pwa.js';
        import { fetchTodaysPuzzle, getTodaysPuzzleInfo } from './assets/js/database.js';
        import { getGameDayString } from './assets/js/timeUtils.js';
        
        // Initialize Supabase client
        const supabaseClient = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anonKey);
        setSupabaseClient(supabaseClient);
        
        // Make Supabase client globally available
        window.supabaseClient = supabaseClient;
        
        // Testing mode check
        if (window.TESTING_MODE) {
            console.log('🧪 TESTING MODE ENABLED - Daily restrictions disabled');
        }
        
        // Initialize PWA features
        initializePWA();
        
        // Set the header date info with comprehensive error handling
        function setHeaderInfo() {
            try {
                const { puzzleNumber } = getTodaysPuzzleInfo();
                const today = new Date();
                const options = { month: 'long', day: 'numeric', year: 'numeric' };
                const formattedDate = today.toLocaleDateString('en-US', options);
                
                const headerElement = document.getElementById('privacy-date-display');
                if (headerElement) {
                    headerElement.textContent = `Puzzle #${puzzleNumber} • ${formattedDate}`;
                } else {
                    console.warn('Header element not found');
                }
            } catch (error) {
                console.error('Error setting header info:', error);
                const headerElement = document.getElementById('privacy-date-display');
                if (headerElement) {
                    headerElement.textContent = 'Daily Word Puzzle';
                }
            }
        }
        
        // Content switching functions
        function hideAllContent() {
            const contents = ['landing-content', 'game-content', 'completion-content', 'failure-content'];
            contents.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    element.style.opacity = '0';
                }
            });
        }
        
        function showContent(targetId) {
            // First hide all content
            const allContent = document.querySelectorAll('#landing-content, #game-content, #completion-content, #failure-content, #countdown-content');
            
            allContent.forEach(content => {
                if (content.style.display !== 'none') {
                    content.style.opacity = '0';
                    content.style.transition = 'opacity 0.3s ease-out';
                }
            });
            
                    setTimeout(() => {
                // Hide all and show target
                allContent.forEach(content => content.style.display = 'none');
                
                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                    targetContent.style.opacity = '0';
                    targetContent.style.transition = 'opacity 0.3s ease-out';
                    
                    setTimeout(() => {
                        targetContent.style.opacity = '1';
                    }, 50);
                }
            }, 300);
        }
        
        // Ad Infrastructure for Try Again functionality
        window.AdManager = {
            // Future Google Ad configuration
            config: {
                enabled: false, // Set to true when ads are ready
                adUnitId: '', // Will be set when Google ads are configured
                timeout: 5000, // Max time to wait for ad to load
            },
            
            // Show full-screen video ad before retry
            async showRetryAd() {
                if (!this.config.enabled) {
                    console.log('Ads not configured, proceeding directly to retry');
                    return true; // Allow retry to proceed
                }
                
                try {
                    console.log('Attempting to show retry ad...');
                    // TODO: Implement Google AdMob/AdSense full-screen video ad
                    // Example structure for future implementation:
                    /*
                    return new Promise((resolve, reject) => {
                        const ad = new googleAds.RewardedVideoAd(this.config.adUnitId);
                        ad.onUserEarnedReward = () => resolve(true);
                        ad.onAdFailedToLoad = () => reject(false);
                        ad.onAdClosed = () => resolve(true);
                        ad.load();
                        ad.show();
                    });
                    */
                    
                    // For now, return true to allow retry
                    return true;
                } catch (error) {
                    console.error('Ad failed to load:', error);
                    return false; // Block retry if ad system fails
                }
            }
        };

        // Try Again: restart the current game with full loading animation experience
        window.retryGame = async function() {
            try {
                // Show ad before allowing retry (future implementation)
                const adSuccess = await window.AdManager.showRetryAd();
                
                if (!adSuccess) {
                    alert('Please try again in a moment.');
                    return;
                }
                
                // Switch to game content
                document.body.classList.add('mobile-game-mode');
                showContent('game-content');
                
                // Play the full loading animation with chimes (same as new game)
                try {
                    await playLoadingAnimation();
                } catch (error) {
                    console.error('Error during retry loading animation:', error);
                    // Continue even if loading animation fails
                }
                
                // Initialize the actual game with database puzzle (same flow as new game)
                try {
                    await initializeGameWithDatabase();
                } catch (error) {
                    console.error('Critical error initializing retry game:', error);
                    // Fallback to basic initialization
                    initializeGame();
                }
                
                // Track retry attempt for analytics
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'retry_game', {
                        event_category: 'game_action',
                        event_label: 'failure_screen_retry'
                    });
                }
            } catch (error) {
                console.error('Error retrying game:', error);
                alert('Unable to restart. Please refresh and try again.');
            }
        }
        
        window.showGameContent = async () => {
            try {
                console.log('Starting game content initialization...');
                
                // Determine puzzle mode based on URL parameters
                const isPackPuzzle = window.puzzleParams.type === 'pack';
                const isArchivePuzzle = window.puzzleParams.type === 'historical';
                const isDailyPuzzle = window.puzzleParams.type === 'daily';
                
                console.log(`Game mode: ${window.puzzleParams.type}`, {
                    isPackPuzzle,
                    isArchivePuzzle, 
                    isDailyPuzzle,
                    params: window.puzzleParams
                });
                
                // Only check daily puzzle completion for daily puzzles
                if (isDailyPuzzle) {
                    try {
                        const hasCompletedToday = await checkIfCompletedToday();
                        if (hasCompletedToday) {
                            // User already played today - redirect to countdown
                            console.log('User already completed today\'s puzzle, redirecting to countdown');
                            showCountdownContent();
                            return;
                        }
                    } catch (error) {
                        console.error('Error checking completion status:', error);
                        // Continue with game start even if completion check fails
                    }
                } else {
                    console.log('Pack/archive puzzle - skipping daily completion check');
                }
                
                // Add mobile game mode class for mobile header switching
                document.body.classList.add('mobile-game-mode');
                showContent('game-content');
                
                // Play loading animation before starting the actual game
                try {
                    await playLoadingAnimation();
                } catch (error) {
                    console.error('Error during loading animation:', error);
                    // Continue even if loading animation fails
                }
                
                // Initialize the actual game with database puzzle
                try {
                    await initializeGameWithDatabase();
                } catch (error) {
                    console.error('Critical error initializing game:', error);
                    // Show error message in game content area
                    const gameContent = document.getElementById('game-content');
                    if (gameContent) {
                        gameContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--error-red);">
                                <h3>Unable to Start Game</h3>
                                <p>There was a problem loading the puzzle. Please try again.</p>
                                <button onclick="window.location.reload()" 
                                        style="margin-top: 20px; padding: 10px 20px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Refresh Page
                                </button>
                                <button onclick="showContent('landing-content')" 
                                        style="margin-top: 10px; margin-left: 10px; padding: 10px 20px; background: var(--gray-400); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Go Back
                                </button>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Critical error in showGameContent:', error);
                // Fallback to landing page
                showContent('landing-content');
                alert('Unable to start game. Please try again.');
            }
        };
        
        window.showLandingContent = () => {
            // Remove mobile game mode class to restore main header
            document.body.classList.remove('mobile-game-mode');
            // Add landing page class to prevent scrolling
            document.body.classList.add('landing-page');
            showContent('landing-content');
        };
        
        // Test function to properly load puzzle data before showing completion screen
        window.testCompletionScreen = async () => {
            try {
                console.log('Testing completion screen - loading today\'s puzzle data...');
                const puzzleData = await fetchTodaysPuzzle();
                console.log('Puzzle data loaded for test:', puzzleData.puzzle.theme);
                
                // Set the theme globally
                window.currentPuzzleTheme = puzzleData.puzzle.theme;
                
                // Initialize game state if needed
                if (!window.gameState) {
                    window.gameState = { currentPuzzle: puzzleData.puzzle };
                } else {
                    window.gameState.currentPuzzle = puzzleData.puzzle;
                }
                
                // Now show the completion screen
                showCompletionContent();
                
            } catch (error) {
                console.error('Failed to load puzzle data for test:', error);
                // Fallback to showing completion screen with fallback theme
                window.currentPuzzleTheme = 'Wedding Traditions';
                showCompletionContent();
            }
        };
        
        window.showCompletionContent = () => {
            // Remove mobile game mode class for completion screen
            document.body.classList.remove('mobile-game-mode');
            showContent('completion-content');
            
            // Update theme with current puzzle theme
            const themeElement = document.getElementById('completion-theme');
            if (themeElement) {
                // Try multiple sources for the theme
                let theme = window.currentPuzzleTheme || 
                           window.gameState?.currentPuzzle?.theme || 
                           window.game?.currentPuzzle?.theme;
                
                if (!theme) {
                    // If no theme available, try to fetch from database
                    console.log('No theme found in memory, should load from database');
                    theme = 'Wedding Traditions'; // Today's actual theme as fallback
                }
                
                themeElement.textContent = `Theme: ${theme}`;
                console.log('Completion screen theme set to:', theme);
            }
            
            // Set up context-aware completion screen
            setTimeout(() => {
                setupCompletionScreenContextAware();
            }, 300); // Wait for content switch to complete
        };
        
        window.showFailureContent = () => {
            // Remove mobile game mode class for failure screen
            document.body.classList.remove('mobile-game-mode');
            showContent('failure-content');
            
            // Update theme with current puzzle theme (for consistency with completion screen)
            // Note: Failure screen doesn't display theme, but this ensures data consistency
            console.log('Failure screen - Current theme:', window.currentPuzzleTheme);
            
            // Set up context-aware failure screen
            setTimeout(() => {
                setupFailureScreenContextAware();
            }, 300); // Wait for content switch to complete
        };

        // Centering Test Function (now built into failure screen)

        window.runCenteringTest = () => {
            console.log("=== CENTERING TEST RESULTS ===");
            
            // Test the header (should be perfectly centered)
            const header = document.querySelector('.header');
            if (header) {
                const headerRect = header.getBoundingClientRect();
                const headerCenterX = headerRect.left + headerRect.width / 2;
                console.log("Header centerX:", headerCenterX);
                console.log("Header bottom:", headerRect.bottom);
            }
            
            // Test the failure content (now using test card structure)
            const failureContainer = document.querySelector('#failure-content');
            const failureScreenContainer = document.querySelector('.failure-screen-container');
            if (failureContainer) {
                const failureRect = failureContainer.getBoundingClientRect();
                const failureCenterX = failureRect.left + failureRect.width / 2;
                console.log("Failure container centerX:", failureCenterX);
                console.log("Failure container top:", failureRect.top);
                console.log("Distance from header bottom to failure top:", failureRect.top - (header ? header.getBoundingClientRect().bottom : 0));
            }
            if (failureScreenContainer) {
                const screenRect = failureScreenContainer.getBoundingClientRect();
                console.log("Failure screen container top:", screenRect.top);
                console.log("Distance from header bottom to screen container:", screenRect.top - (header ? header.getBoundingClientRect().bottom : 0));
            }
            
            // Test the main container
            const container = document.querySelector('.container');
            if (container) {
                const containerRect = container.getBoundingClientRect();
                const containerCenterX = containerRect.left + containerRect.width / 2;
                console.log("Main container centerX:", containerCenterX);
            }
            

            
            // Viewport center reference
            const viewportCenter = window.innerWidth / 2;
            console.log("Viewport center:", viewportCenter);
            
            // Color coding for visual inspection
            console.log("=== VISUAL OUTLINE TEST ===");
            
            // Clear previous outlines
            document.querySelectorAll('*').forEach(el => {
                el.style.outline = '';
                el.style.outlineOffset = '';
            });
            
            // Color the header (GREEN - reference point)
            if (header) {
                header.style.outline = '3px solid green';
                header.style.outlineOffset = '-3px';
                console.log("Header outlined in GREEN (reference)");
            }
            
            // Color the failure container (BLUE - should be centered!)
            if (failureContainer) {
                failureContainer.style.outline = '3px solid blue';
                failureContainer.style.outlineOffset = '-3px';
                console.log("Failure container outlined in BLUE (should align with GREEN header)");
            }
            
            // Color the main container (PURPLE)
            if (container) {
                container.style.outline = '3px solid purple';
                container.style.outlineOffset = '-3px';
                console.log("Main container outlined in PURPLE");
            }
            

        };

        window.showCountdownContent = async () => {
            // Check if user is authenticated first
            try {
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                
                if (user) {
                    // User is authenticated - redirect to home instead of showing countdown
                    console.log('Authenticated user accessing countdown, redirecting to home');
                    window.location.href = '/home';
                    return;
                }
            } catch (error) {
                console.error('Error checking auth in countdown:', error);
                // Continue to show countdown if auth check fails
            }
            
            // Remove mobile game mode class for countdown screen
            document.body.classList.remove('mobile-game-mode');
            showContent('countdown-content');
            

            
            // Update countdown page info
            const today = new Date();
            const puzzleNumber = Math.floor((today - new Date('2025-01-01')) / (1000 * 60 * 60 * 24)) + 1;
            const options = { month: 'long', day: 'numeric', year: 'numeric' };
            const formattedDate = today.toLocaleDateString('en-US', options);
            
            // Update header date (reuse the existing header)
            document.getElementById('privacy-date-display').textContent = `Puzzle #${puzzleNumber} • ${formattedDate}`;
            
            // Show signup card for non-authenticated users
            const signupCard = document.getElementById('countdown-signup-card');
            if (signupCard) {
                signupCard.style.display = 'block';
            }
            
            // Start countdown timer
            startCountdownTimer();
        };
        
        // Replay game function for testing mode
        window.replayGame = () => {
            console.log('Replaying game in testing mode');
            
            // Clear any completion cookies for testing
            if (window.TESTING_MODE) {
                clearTestingCompletionData();
            }
            
            // Reset game state
            if (window.gameState) {
                window.gameState.currentRungIndex = 0;
                window.gameState.attempts = [];
                window.gameState.gameCompleted = false;
                window.gameState.startTime = Date.now();
            }
            
            // Reset any game instances
            if (window.game) {
                window.game = null;
            }
            
            // Remove mobile game mode class to restore main header
            document.body.classList.remove('mobile-game-mode');
            
            // Go back to landing page
            showContent('landing-content');
            
            console.log('Returned to landing page for replay');
        };
        
        // Clear completion data for testing mode
        function clearTestingCompletionData() {
            if (!window.TESTING_MODE) return;
            
            const today = getGameDayString(new Date());
            const cookieName = `ladder_played_${today}`;
            
            // Remove completion cookie
            document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            console.log('Cleared testing completion data');
        }

        // Check if user has already completed today's puzzle
        async function checkIfCompletedToday() {
            try {
                // In testing mode, always allow play
                if (window.TESTING_MODE) {
                    console.log('Testing mode enabled - allowing play');
                    return false;
                }
                
                // Get today's date string using the same format as the game
                const today = getGameDayString(new Date());
                
                // First, check if user is authenticated
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                
                if (user) {
                    // Authenticated user - check database
                    const { data, error } = await window.supabaseClient
                        .from('puzzle_completions')
                        .select('id')
                        .eq('user_id', user.id)
                        .eq('puzzle_date', today)
                        .limit(1);
                    
                    if (error) {
                        console.error('Error checking completion status:', error);
                        return false; // Allow play if database check fails
                    }
                    
                    return data && data.length > 0;
                } else {
                    // Non-authenticated user - check cookies
                    return checkPuzzlePlayedCookie(today);
                }
            } catch (error) {
                console.error('Error in checkIfCompletedToday:', error);
                return false; // Allow play if check fails
            }
        }

        // Check if puzzle completion cookie exists for today
        function checkPuzzlePlayedCookie(dateString) {
            const cookieName = `ladder_played_${dateString}`;
            const cookies = document.cookie.split(';');
            
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === cookieName && value === 'true') {
                    console.log('Found completion cookie for today');
                    return true;
                }
            }
            
            return false;
        }

        function startCountdownTimer() {
            function updateCountdown() {
                // Calculate time until next 3am ET (when new puzzle releases)
                const now = new Date();
                
                // Get current ET time
                const etNow = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                const etHour = etNow.getHours();
                
                // Calculate next 3am ET in user's local time
                let next3amET;
                
                if (etHour >= 3) {
                    // If it's past 3am ET today, target tomorrow's 3am ET
                    next3amET = new Date(etNow);
                    next3amET.setDate(next3amET.getDate() + 1);
                    next3amET.setHours(3, 0, 0, 0);
                } else {
                    // If it's before 3am ET today, target today's 3am ET
                    next3amET = new Date(etNow);
                    next3amET.setHours(3, 0, 0, 0);
                }
                
                // Convert ET time back to user's timezone for countdown
                const etOffset = etNow.getTimezoneOffset();
                const userOffset = now.getTimezoneOffset();
                const timezoneAdjustment = (etOffset - userOffset) * 60 * 1000;
                
                const next3amLocal = new Date(next3amET.getTime() + timezoneAdjustment);
                const timeUntilNext = next3amLocal - now;
                
                if (timeUntilNext <= 0) {
                    // Time's up! Reload for new puzzle
                    location.reload();
                    return;
                }
                
                // Calculate hours, minutes, seconds
                const hours = Math.floor(timeUntilNext / (1000 * 60 * 60));
                const minutes = Math.floor((timeUntilNext % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeUntilNext % (1000 * 60)) / 1000);
                
                // Format time display
                const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                const timerElement = document.getElementById('countdown-timer');
                if (timerElement) {
                    timerElement.textContent = timeString;
                }
            }
            
            // Update immediately and then every second
            updateCountdown();
            const countdownInterval = setInterval(updateCountdown, 1000);
            
            // Store interval so we can clear it if needed
            window.countdownInterval = countdownInterval;
        }

        // Basic Game State
        window.gameState = {
            currentRungIndex: 0,
            typedWord: '',
            gameEnded: false,
            wrongGuesses: 0,
            maxWrongGuesses: 3,
            hintsUsed: 0,
            maxHints: 3,
            hintsRemaining: 3,
            startTime: null,
            timerInterval: null,
            currentPuzzle: {
                theme: 'Mindfulness',
                words: [
                    { word: 'BOOK', hint: 'Reading material' },
                    { word: 'LIBRARY', hint: 'Quiet sanctuary' },
                    { word: 'SILENCE', hint: 'No sound' },
                    { word: 'MEDITATION', hint: 'Mindful calm' },
                    { word: 'PEACE', hint: 'Inner calm' },
                    { word: 'FINISH', hint: '' }
                ]
            }
        };

        // Core Game Functions
        function getCurrentWordData() {
            return window.gameState.currentPuzzle.words[window.gameState.currentRungIndex];
        }

        function addLetterToWord(letter) {
            // Check if game is ended
            if (window.gameState.gameEnded) {
                console.log('Game ended, ignoring input');
                return;
            }
            
            const currentWordData = getCurrentWordData();
            const wordLength = currentWordData.word.length;
            
            // Don't allow typing beyond word length
            if (window.gameState.typedWord.length >= wordLength) {
                console.log('Word already complete, ignoring input');
                return;
            }
            
            // Add letter to typed word
            window.gameState.typedWord += letter;
            console.log('Added letter:', letter, 'Current word:', window.gameState.typedWord);
            
            // Update the display
            updateWordDisplay();
        }

        function handleBackspace() {
            if (window.gameState.typedWord.length > 0) {
                // Remove last character
                window.gameState.typedWord = window.gameState.typedWord.slice(0, -1);
                
                // Update the display
                updateWordDisplay();
            }
        }

                function updateWordDisplay() {
            const currentWordData = getCurrentWordData();
            const correctWord = currentWordData.word;
            
            // Get current rung letter boxes (both desktop and mobile)
            const desktopRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            
            const desktopBoxes = desktopRung ? Array.from(desktopRung.querySelectorAll('.letter-box')) : [];
            const mobileBoxes = mobileRung ? Array.from(mobileRung.querySelectorAll('.letter-box')) : [];
            
            // Helper to run an operation on both desktop & mobile boxes in parallel
            const forEachPair = (cb) => {
                const len = Math.max(desktopBoxes.length, mobileBoxes.length);
                for (let i = 0; i < len; i++) {
                    cb(desktopBoxes[i], i);
                    cb(mobileBoxes[i], i);
                }
            };
            
            // Clear previous state
            forEachPair((box) => {
                if (!box) return;
                box.classList.remove('current', 'user-typed', 'typed-through', 'selected');
                if (box.dataset.isRevealed !== 'true') {
                    box.classList.remove('filled');
                    box.textContent = '';
                }
                // Preserve hint-revealed styling by not removing the class or inline styles
            });
            
            // Fill in typed letters
            for (let i = 0; i < window.gameState.typedWord.length && i < correctWord.length; i++) {
                const typedLetter = window.gameState.typedWord[i];
                
                [desktopBoxes[i], mobileBoxes[i]].forEach((letterBox) => {
                    if (!letterBox) return;
                    const isRevealed = letterBox.dataset.isRevealed === 'true';
                    const isHintRevealed = letterBox.classList.contains('hint-revealed');
                    
                    if (isRevealed && isHintRevealed) {
                        // Typing through orange hint letter - make it orange background with white text
                        letterBox.classList.add('typed-through');
                    } else if (isRevealed && !isHintRevealed) {
                        // Typing through normal gray revealed letter - make it dark gray with white text
                        letterBox.classList.add('typed-through');
                    } else {
                        // User typing in empty box - black text with white background
                        letterBox.textContent = typedLetter;
                        letterBox.classList.add('user-typed');
                        // Don't add 'filled' class for user typed letters
                    }
                });
            }
            
            // Show current typing position indicator
            const nextIndex = window.gameState.typedWord.length;
            if (nextIndex < correctWord.length) {
                [desktopBoxes[nextIndex], mobileBoxes[nextIndex]].forEach(box => {
                    if (box) {
                        box.classList.add('current');
                    }
                });
            }
            
            // Check if word is complete and auto-submit
            if (window.gameState.typedWord.length === correctWord.length) {
                // Word is complete, check if it's correct
                const guess = buildCurrentGuess();
                if (guess === correctWord) {
                    // Correct! Auto-advance to next word
            setTimeout(() => {
                        correctGuess();
                    }, 200); // Reduced delay for faster response
                } else {
                    // Incorrect word, show feedback but don't advance
                    setTimeout(() => {
                        playSound('wrong');
                        vibrate([200, 100, 200]); // Error vibration pattern
                        wrongGuess();
            }, 100);
                }
            }
        }
        
        function buildCurrentGuess() {
            const currentWordData = getCurrentWordData();
            const correctWord = currentWordData.word;
            
            if (window.gameState.typedWord.length < correctWord.length) {
                return null; // Incomplete word
            }
            
            // Build guess by combining typed letters with revealed letters
            let guess = '';
            const desktopRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const letterBoxes = desktopRung ? Array.from(desktopRung.querySelectorAll('.letter-box')) : [];
            
            for (let i = 0; i < correctWord.length; i++) {
                const letterBox = letterBoxes[i];
                
                if (letterBox && letterBox.dataset.isRevealed === 'true') {
                    // Use revealed letter
                    guess += letterBox.dataset.correctLetter;
                } else if (i < window.gameState.typedWord.length) {
                    // Use typed letter
                    guess += window.gameState.typedWord[i];
                } else {
                    // This shouldn't happen if typedWord.length >= correctWord.length
                    return null;
                }
            }
            
            return guess;
        }

        function correctGuess() {
            console.log('Correct word!', window.gameState.typedWord);
            
            // Play correct sound and haptic feedback
            playSound('correct');
            vibrate([100, 50, 100]);
            
            // Play letter cascade animation
            playLetterCascadeAnimation();
            
            // Mark current rung as completed after cascade
            setTimeout(() => {
                const desktopRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
                const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
                
                [desktopRung, mobileRung].forEach(rung => {
                    if (rung) {
                        rung.classList.remove('active');
                        rung.classList.add('completed');
                    }
                });
                
                // Move to next word
                window.gameState.currentRungIndex++;
                window.gameState.typedWord = '';
                
                // Animate mobile descent after completing a card (from 2nd card onwards) - EXACT TIMING AS OLD VERSION
                if (window.gameState.currentRungIndex >= 1) {
                    animateMobileDescent();
                }
                
                // Check if game is complete  
                if (window.gameState.currentRungIndex >= window.gameState.currentPuzzle.words.length - 1) {
                    // Game complete!
                    console.log('Game completed!');
                    
                    // Stop timer and store final time
                    if (window.gameState.timerInterval) {
                        clearInterval(window.gameState.timerInterval);
                    }
                    window.gameState.finalTimeMs = Date.now() - window.gameState.startTime;
                    window.gameState.gameEnded = true;
                    
                    // Update completion screen stats
                    const finalTime = window.gameState.finalTimeMs;
                    const minutes = Math.floor(finalTime / 60000);
                    const seconds = Math.floor((finalTime % 60000) / 1000);
                    const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('completion-time').textContent = timeString;
                    document.getElementById('completion-theme').textContent = `Theme: ${window.currentPuzzleTheme || 'Library Studies'}`;
                    
                    // Track completion in database/cookies
                    if (window.game && window.game.trackCompletion) {
                        window.game.trackCompletion(timeString);
                    }
                    
                    // Display FINISH rung with proper animation sequence
                    displayFinishRung();
                } else {
                    // Activate next rung
                    const nextDesktopRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
                    const nextMobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
                    
                    [nextDesktopRung, nextMobileRung].forEach(rung => {
                        if (rung) {
                            rung.classList.add('active');
                        }
                    });
                    
                    updateWordDisplay();
                }
            }, 600); // Wait for cascade animation
        }

                function wrongGuess() {
            console.log('Wrong word!', window.gameState.typedWord);
            
            // Increment wrong guesses counter
            window.gameState.wrongGuesses++;
            const triesLeft = window.gameState.maxWrongGuesses - window.gameState.wrongGuesses;
            document.getElementById('tries-left').textContent = triesLeft;
            
            // Sync mobile tries left
            const mobileTriesLeft = document.getElementById('mobile-tries-left');
            if (mobileTriesLeft) mobileTriesLeft.textContent = triesLeft;
            
            if (triesLeft === 0) {
                // Game over - show failure cascade then end game
                playFailureCascade();
            } else {
                // Show red shake animation on user-typed letters
                showWrongWordAnimation();
                
                // Clear the word after animation completes
                setTimeout(() => {
                    window.gameState.typedWord = '';
                    updateWordDisplay();
                }, 700); // Wait for shake animation to complete
            }
        }
        
        function showWrongWordAnimation() {
            // Get current rung letter boxes (both desktop and mobile)
            const desktopRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            
            const desktopBoxes = desktopRung ? Array.from(desktopRung.querySelectorAll('.letter-box')) : [];
            const mobileBoxes = mobileRung ? Array.from(mobileRung.querySelectorAll('.letter-box')) : [];
            const letterBoxes = [...desktopBoxes, ...mobileBoxes];
            
            // Add wrong-word class to ALL letters in current word
            letterBoxes.forEach((letterBox) => {
                letterBox.classList.add('wrong-word');
            });
            
            // Remove wrong-word class after animation
            setTimeout(() => {
                letterBoxes.forEach(letterBox => {
                    letterBox.classList.remove('wrong-word');
                });
            }, 600);
        }

        function animateMobileDescent() {
            // Only animate on mobile
            if (window.innerWidth > 480) return;
            
            const mobileViewport = document.querySelector('.mobile-ladder-viewport');
            if (!mobileViewport) return;
            
            // Calculate partial scroll to keep previous card visible
            const cardHeight = 160; // Card height + gap + padding
            const partialScroll = cardHeight * 0.6; // Only scroll 60% of card height
            let scrollPosition = (window.gameState.currentRungIndex - 1) * partialScroll;
            
            // Add extra scroll for the final card to fully show FINISH
            const isShowingFinishCard = window.gameState.currentRungIndex >= window.gameState.currentPuzzle.words.length - 1;
            if (isShowingFinishCard) {
                scrollPosition += 50; // Extra 40px to fully show FINISH card
            }
            
            // Smooth scroll animation (feels like descending the ladder)
            mobileViewport.scrollTo({
                top: scrollPosition,
                behavior: 'smooth'
            });
        }

        // Update header display based on puzzle type
        function updateHeaderForPuzzleType(puzzleData) {
            const headerDateDisplay = document.getElementById('date-display');
            if (!headerDateDisplay) return;
            
            switch (window.puzzleParams.type) {
                case 'daily':
                    // Keep existing daily puzzle header format
                    console.log('📅 Keeping daily puzzle header format');
                    break;
                    
                case 'pack':
                    if (puzzleData.puzzleNumber) {
                        headerDateDisplay.textContent = puzzleData.puzzleNumber;
                        console.log('📦 Updated header for pack puzzle:', puzzleData.puzzleNumber);
                    }
                    break;
                    
                case 'historical':
                    headerDateDisplay.textContent = `Historical Puzzle • ${window.puzzleParams.date}`;
                    console.log('📜 Updated header for historical puzzle');
                    break;
            }
        }

        // Database Game Initialization - Fetches real puzzle and creates LadderGame
        async function initializeGameWithDatabase() {
            try {
                console.log(`🎮 Initializing ${window.puzzleParams.type} puzzle...`);
                let puzzleData;
                
                // Load puzzle based on type
                switch (window.puzzleParams.type) {
                    case 'daily':
                        // Use existing daily puzzle logic
                        console.log('📅 Loading daily puzzle...');
                        puzzleData = await fetchTodaysPuzzle();
                        break;
                        
                    case 'pack':
                        // Fetch puzzle from a specific pack
                        if (!window.puzzleParams.packId || !window.puzzleParams.puzzleId) {
                            throw new Error('Pack ID and Puzzle ID required for pack puzzles');
                        }
                        console.log(`📦 Loading pack puzzle: ${window.puzzleParams.packId}/${window.puzzleParams.puzzleId}`);
                        puzzleData = await window.LadderGame.prototype.fetchPackPuzzle(
                            window.puzzleParams.packId, 
                            window.puzzleParams.puzzleId
                        );
                        break;
                        
                    case 'historical':
                        // Fetch historical daily puzzle (future enhancement)
                        console.log(`📜 Loading historical puzzle: ${window.puzzleParams.date}`);
                        puzzleData = await fetchTodaysPuzzle(); // Fallback for now
                        break;
                        
                    default:
                        console.warn('Unknown puzzle type, defaulting to daily');
                        puzzleData = await fetchTodaysPuzzle();
                }
                
                console.log(`Database puzzle fetched successfully: ${puzzleData.puzzle.theme}`);
                
                // Store puzzle theme globally for completion screens
                window.currentPuzzleTheme = puzzleData.puzzle.theme;
                
                // Create LadderGame instance with database puzzle
                window.game = new LadderGame(puzzleData);
                
                // Update header with appropriate puzzle information
                updateHeaderForPuzzleType(puzzleData);
                
                // Initialize the game with the fetched puzzle
                initializeGame();
                
                console.log(`✅ Game initialized successfully with ${window.puzzleParams.type} puzzle`);
                
            } catch (error) {
                console.error('Failed to fetch puzzle from database, using fallback:', error);
                
                // Validate error and provide detailed logging
                if (error.name === 'NetworkError') {
                    console.error('Network error: Check internet connection');
                } else if (error.message.includes('puzzle')) {
                    console.error('Puzzle data error:', error.message);
                } else {
                    console.error('Unexpected error during puzzle fetch:', error);
                }
                
                // Fallback with comprehensive error handling
                try {
                    // Set fallback theme for hardcoded puzzle
                    window.currentPuzzleTheme = "Library Studies"; // Fallback theme
                    
                    // Fallback to hardcoded puzzle
                    window.game = new LadderGame(); // Uses existing hardcoded puzzle
                    initializeGame();
                    
                } catch (fallbackError) {
                    console.error('Critical error: Fallback game initialization failed:', fallbackError);
                    // Show user-friendly error message
                    const gameContent = document.getElementById('game-content');
                    if (gameContent) {
                        gameContent.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--error-red);">
                                <h3>Unable to Load Game</h3>
                                <p>Please refresh the page to try again.</p>
                                <button onclick="window.location.reload()" 
                                        style="margin-top: 20px; padding: 10px 20px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    Refresh Page
                                </button>
                            </div>
                        `;
                    }
                }
            }
        }

        // Game Initialization
        function initializeGame() {
            console.log('Initializing game with hardcoded puzzle');
            
            // Reset game state
            window.gameState.currentRungIndex = 0;
            window.gameState.typedWord = '';
            window.gameState.gameEnded = false;
            window.gameState.wrongGuesses = 0;
            window.gameState.hintsUsed = 0;
            window.gameState.hintsRemaining = 3;
            
            // Initialize counter displays
            document.getElementById('hints-remaining').textContent = window.gameState.hintsRemaining;
            document.getElementById('tries-left').textContent = window.gameState.maxWrongGuesses;
            document.getElementById('mobile-hints-remaining').textContent = window.gameState.hintsRemaining;
            document.getElementById('mobile-tries-left').textContent = window.gameState.maxWrongGuesses;
            
            // Start the timer
            startTimer();
            
            // Create the actual game ladder
            const ladder = document.getElementById('ladder');
            const mobileLadder = document.getElementById('mobile-ladder');
            
            // Clear loading content
            [ladder, mobileLadder].forEach(ladderEl => {
                if (ladderEl) {
                    ladderEl.innerHTML = '';
                }
            });
            
            // Create game rungs with hardcoded puzzle
            window.gameState.currentPuzzle.words.forEach((wordData, index) => {
                [ladder, mobileLadder].forEach((ladderEl, ladderIndex) => {
                    if (!ladderEl) return;
                    
                    const rung = document.createElement('div');
                    rung.className = 'rung';
                    rung.id = `${ladderIndex === 0 ? '' : 'mobile-'}rung-${index}`;
                    
                    // Mark first rung as active
                    if (index === 0) {
                        rung.classList.add('active');
                    }
                    
                    // Special handling for FINISH rung
                    if (wordData.word === 'FINISH') {
                        rung.classList.add('finish-rung');
                    }
                    
                    const wordDisplay = document.createElement('div');
                    wordDisplay.className = 'word-display';
                    
                    // Create letter boxes
                    for (let i = 0; i < wordData.word.length; i++) {
                        const letterBox = document.createElement('div');
                        letterBox.className = 'letter-box';
                        letterBox.dataset.wordIndex = index;
                        letterBox.dataset.letterIndex = i;
                        letterBox.dataset.correctLetter = wordData.word[i];
                        
                        if (wordData.word === 'FINISH') {
                            letterBox.classList.add('filled', 'finish-placeholder');
                            letterBox.textContent = wordData.word[i];
                        } else {
                            // Use revealed_letters from database puzzle or fallback to hardcoded
                            if (wordData.revealed_letters && wordData.revealed_letters.includes(i)) {
                                // Database puzzle - use revealed_letters array
                                letterBox.classList.add('filled');
                                letterBox.textContent = wordData.word[i];
                                letterBox.dataset.isRevealed = 'true';
                            } else if (!wordData.revealed_letters && 
                                       ((index === 0 && i === 0) || // Fallback for hardcoded puzzle
                                        (index === 1 && i === 0) || 
                                        (index === 2 && i === 2))) {
                                // Hardcoded puzzle fallback
                                letterBox.classList.add('filled');
                                letterBox.textContent = wordData.word[i];
                                letterBox.dataset.isRevealed = 'true';
                            }
                            
                            // Make letter boxes interactive for hints
                            if (index >= 0) { // All future words can have hints
                                letterBox.classList.add('interactive');
                            }
                        }
                        
                        wordDisplay.appendChild(letterBox);
                    }
                    
                    rung.appendChild(wordDisplay);
                    
                    // Add hint for non-FINISH words
                    if (wordData.word !== 'FINISH' && wordData.hint) {
                        const hint = document.createElement('div');
                        hint.className = 'word-hint';
                        hint.textContent = wordData.hint;
                        rung.appendChild(hint);
                    }
                    
                    ladderEl.appendChild(rung);
                });
            });
            
            // Initialize the first word display
            updateWordDisplay();
            
            console.log('Game initialized successfully');
            console.log('Current game state:', window.gameState);
            console.log('Current word:', getCurrentWordData());
        }

        // Helper function to get current word letter boxes
        function getCurrentWordLetterBoxes() {
            const currentRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const desktopBoxes = currentRung ? currentRung.querySelectorAll('.letter-box') : [];
            
            // Also get mobile letter boxes if they exist
            const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const mobileBoxes = mobileRung ? mobileRung.querySelectorAll('.letter-box') : [];
            
            // Return both sets of boxes for synchronized updates
            return [...desktopBoxes, ...mobileBoxes];
        }

        // Animation Functions
        function playLetterCascadeAnimation() {
            const letterBoxes = getCurrentWordLetterBoxes();
            const isMobile = window.innerWidth <= 480;
            const stagger = isMobile ? 80 : 60; // slower cascade on mobile for smoother feel
            
            letterBoxes.forEach((letterBox, index) => {
                setTimeout(() => {
                    // Start the cascade animation
                    letterBox.classList.add('cascade-fill');
                    
                    // Apply permanent completed state immediately
                    letterBox.classList.remove('typed-through', 'hint-revealed'); // Override gray and hint styling
                    letterBox.classList.add('filled'); // Add filled class for permanent green
                    
                    // Set permanent completed styling (green background/border)
                    letterBox.style.backgroundColor = '#6aaa64';
                    letterBox.style.borderColor = '#6aaa64';
                    letterBox.style.color = 'white';
                    
                    // Remove animation class after it completes but keep completed styling
                    setTimeout(() => {
                        letterBox.classList.remove('cascade-fill');
                        // Keep the permanent green styling - don't remove it
                    }, 400);
                }, index * 40); // 40ms stagger between each letter
            });
        }

        function playFailureCascade() {
            window.gameState.gameEnded = true;
            if (window.gameState.timerInterval) {
                clearInterval(window.gameState.timerInterval);
            }
            
            // Play failure sound immediately
            playSound('failure');
            vibrate([300, 150, 300, 150, 500]); // Long disappointed vibration
            
            // Get only the current rung that the user failed on
            const currentRung = document.querySelector(`#ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${window.gameState.currentRungIndex + 1})`);
            if (!currentRung) return;
            
            // Remove active class immediately to stop orange border/shadow
            currentRung.classList.remove('active');
            if (mobileRung) mobileRung.classList.remove('active');
            
            const wordData = getCurrentWordData();
            const desktopBoxes = Array.from(currentRung.querySelectorAll('.letter-box'));
            const mobileBoxes = mobileRung ? Array.from(mobileRung.querySelectorAll('.letter-box')) : [];
            const allBoxes = [...desktopBoxes, ...mobileBoxes];
            
            // Reveal the current word letters and apply cascade animation
            allBoxes.forEach((letterBox, letterIndex) => {
                const actualLetterIndex = letterIndex % wordData.word.length; // Handle desktop/mobile duplication
                setTimeout(() => {
                    const correctLetter = wordData.word[actualLetterIndex];
                    
                    // Reveal the letter and override any existing styling
                    letterBox.textContent = correctLetter;
                    letterBox.classList.remove('filled', 'typed-through', 'finish-placeholder', 'current', 'interactive', 'user-typed'); // Remove ALL styling classes
                    letterBox.classList.add('failure-cascade');
                    
                    // Force remove any orange styling immediately
                    letterBox.style.borderColor = '#d3d6da';
                    letterBox.style.borderWidth = '2px';
                    letterBox.style.boxShadow = 'none';
                    letterBox.style.animation = 'failureCascade 0.5s ease-out';
                    
                    // Apply permanent red styling after animation
                    setTimeout(() => {
                        letterBox.style.backgroundColor = '#e74c3c';
                        letterBox.style.borderColor = '#e74c3c';
                        letterBox.style.color = 'white';
                        letterBox.classList.remove('failure-cascade');
                    }, 500);
                }, actualLetterIndex * 80); // 80ms between letters
            });
            
            // After letter cascade completes, turn the entire rung red
            const cascadeDelay = (wordData.word.length * 80) + 500; // Wait for cascade + animation
            setTimeout(() => {
                // Turn the entire current rung red to match the letters
                currentRung.classList.add('failed');
                if (mobileRung) mobileRung.classList.add('failed');
            }, cascadeDelay);
            
            // Update failure screen stats
            const finalTime = Date.now() - window.gameState.startTime;
            const minutes = Math.floor(finalTime / 60000);
            const seconds = Math.floor((finalTime % 60000) / 1000);
            const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            document.getElementById('failure-time').textContent = timeString;
            
            // Track failure in database/cookies
            if (window.game && window.game.trackFailure) {
                window.game.trackFailure(timeString);
            }
            
            // Set completion cookie for non-authenticated users (they played the puzzle)
            if (window.game && window.game.setPuzzlePlayedCookie) {
                window.game.setPuzzlePlayedCookie();
            }
            
            // Show failure modal after rung turns red - longer pause to let user read the correct word
            const finalDelay = cascadeDelay + 1000; // 1 second pause after rung color change to read the word
            setTimeout(() => {
                window.showFailureContent();
            }, finalDelay);
        }

        // Display FINISH rung, immediately turn green, then start cascade animation
        function displayFinishRung() {
            const finishIndex = window.gameState.currentPuzzle.words.length - 1;
            const desktopRung = document.querySelector(`#ladder .rung:nth-child(${finishIndex + 1})`);
            const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${finishIndex + 1})`);
            if (!desktopRung) return;
            
            // Check if mobile for different completion animation
            const isMobile = window.innerWidth <= 480;
            
            if (isMobile) {
                // Mobile: Play letter cascade with chime, then fade screen
                playMobileFinishCascade(desktopRung, mobileRung);
            } else {
                // Desktop: Keep existing immediate green behavior
                // Get all letter boxes from both desktop and mobile
                const allBoxes = [
                    ...desktopRung.querySelectorAll('.letter-box'),
                    ...(mobileRung ? mobileRung.querySelectorAll('.letter-box') : [])
                ];
                
                // Immediately turn all FINISH letters green (no cascade animation)
                allBoxes.forEach((letterBox) => {
                    // Remove finish-placeholder styling and apply permanent completed state
                    letterBox.classList.remove('finish-placeholder', 'typed-through', 'hint-revealed');
                    letterBox.classList.add('filled'); // Add filled class for permanent green
                    
                    // Set permanent completed styling (same as other completed words)
                    letterBox.style.backgroundColor = '#6aaa64';
                    letterBox.style.borderColor = '#6aaa64';
                    letterBox.style.color = 'white';
                });
                
                // Immediately turn the entire FINISH rung green (like regular words)
                desktopRung.classList.add('completed');
                if (mobileRung) mobileRung.classList.add('completed');
                
                // Play finish celebration sound and haptic feedback
                playSound('finish');
                vibrate([200, 100, 200, 100, 300]);
                
                // Small delay to ensure FINISH box color change is visible before cascade
                setTimeout(() => {
                    playCompletionAnimation();
                }, 400); // Longer delay for mobile timing fix
            }
        }

        // Mobile-specific finish cascade animation with chime sync and screen fade
        function playMobileFinishCascade(desktopRung, mobileRung) {
            // Get mobile letter boxes (prioritize mobile if available)
            const letterBoxes = mobileRung ? 
                Array.from(mobileRung.querySelectorAll('.letter-box')) :
                Array.from(desktopRung.querySelectorAll('.letter-box'));
            
            // Start the chime immediately
            playSound('finish');
            vibrate([200, 100, 200, 100, 300]);
            
            // Play letter cascade animation (similar to regular word cascade)
            letterBoxes.forEach((letterBox, index) => {
                setTimeout(() => {
                    // Start the cascade animation
                    letterBox.classList.add('cascade-fill');
                    
                    // Apply permanent completed state immediately
                    letterBox.classList.remove('finish-placeholder', 'typed-through', 'hint-revealed');
                    letterBox.classList.add('filled');
                    
                    // Set permanent completed styling (green background/border)
                    letterBox.style.backgroundColor = '#6aaa64';
                    letterBox.style.borderColor = '#6aaa64';
                    letterBox.style.color = 'white'; // Use white like other cascade animations
                    
                    // Remove animation class after it completes but keep completed styling
                    setTimeout(() => {
                        letterBox.classList.remove('cascade-fill');
                    }, 400);
                }, index * 80); // 80ms stagger between each letter (slower than regular words for emphasis)
            });
            
            // Mark the rungs as completed after cascade starts
            setTimeout(() => {
                desktopRung.classList.add('completed');
                if (mobileRung) mobileRung.classList.add('completed');
            }, 200); // Small delay to see first letters start cascading
            
            // Calculate total cascade time: (number of letters * 80ms) + animation duration + extended buffer
            const cascadeTime = (letterBoxes.length * 80) + 400 + 800; // Increased buffer from 300ms to 800ms
            
            // After cascade completes, add fade transition to completion screen
            setTimeout(() => {
                // Screen is already properly positioned from first scroll - no need to scroll again
                // Removed scrollIntoView to prevent unwanted second scroll that pushes completion cards up
                
                // Start fade out of game screen
                const gameContent = document.getElementById('game-content');
                if (gameContent) {
                    gameContent.style.transition = 'opacity 0.8s ease-out'; // Longer fade
                    gameContent.style.opacity = '0';
                }
                
                // Show completion screen after fade completes
                setTimeout(() => {
                    showCompletionContent();
                }, 800); // Wait for fade to complete
            }, cascadeTime);
        }

        function playCompletionAnimation() {
            console.log('Playing completion animation');
            
            // Add celebration class to the entire ladder
            const ladder = document.getElementById('ladder');
            const mobileLadder = document.getElementById('mobile-ladder');
            
            [ladder, mobileLadder].forEach(ladderEl => {
                if (ladderEl) {
                    ladderEl.classList.add('completion-celebrate');
                }
            });
            
            // Animate each rung from bottom to top with staggered timing
            const totalRungs = window.gameState.currentPuzzle.words.length;
            
            for (let i = 0; i < totalRungs; i++) {
                const rungIndex = totalRungs - 1 - i; // Start from bottom (last index)
                const delay = i * 150; // 150ms between each rung animation
                
            setTimeout(() => {
                    const desktopRung = document.querySelector(`#ladder .rung:nth-child(${rungIndex + 1})`);
                    const mobileRung = document.querySelector(`#mobile-ladder .rung:nth-child(${rungIndex + 1})`);
                    
                    [desktopRung, mobileRung].forEach(rung => {
                        if (rung) {
                            rung.classList.add('climbing-animation');
                            
                            // Remove animation class after it completes
                            setTimeout(() => {
                                rung.classList.remove('climbing-animation');
                            }, 800);
                        }
                    });
                }, delay);
            }
            
            // End the game after all animations complete
            const totalAnimationTime = (totalRungs * 150) + 800 + 500; // stagger + animation + buffer
                setTimeout(() => {
                showCompletionContent();
            }, totalAnimationTime);
        }

        function playLoadingAnimation() {
            return new Promise((resolve) => {
                console.log('Playing loading animation');
                
                // Play loading sound
                setTimeout(() => {
                    playSound('loading');
                }, 300);
                
                // Create temporary loading rungs that animate in
                const ladder = document.getElementById('ladder');
                const mobileLadder = document.getElementById('mobile-ladder');
                
                // Clear existing content
                [ladder, mobileLadder].forEach(ladderEl => {
                    if (ladderEl) {
                        ladderEl.innerHTML = '';
                    }
                });
                
                // Create loading rungs - different styles for desktop vs mobile
                for (let i = 0; i < 6; i++) {
                    const isFinish = i === 5;
                    
                    [ladder, mobileLadder].forEach((ladderEl, ladderIndex) => {
                        if (!ladderEl) return;
                        
                        const isMobile = ladderIndex === 1; // mobileLadder is second in array
                        
                        const rung = document.createElement('div');
                        rung.className = 'rung';
                        rung.id = `${isMobile ? 'mobile-' : ''}loading-rung-${i}`;
                        rung.style.opacity = '0.3';
                        
                        if (isMobile) {
                            // Mobile: Dynamic rungs that adapt to available viewport
                            rung.className += ' mobile-loading-rung';
                            rung.style.opacity = '0';
                            
                            // Calculate height based on actual mobile-ladder-viewport constraints
                            // Based on: max-height: calc(100vh - 115px - 210px)
                            const viewportReduction = 115; // From CSS: mobile header + container padding
                            const keyboardHeight = 210; // Mobile keyboard height
                            const ladderPadding = 32; // 12px top + 20px bottom from mobile-ladder CSS
                            const totalRungs = 6;
                            const rungMargins = 8; // 4px top + 4px bottom per rung
                            
                            // Use the same calculation as the actual mobile-ladder-viewport
                            const mobileViewportHeight = window.innerHeight - viewportReduction - keyboardHeight;
                            const availableHeight = mobileViewportHeight - ladderPadding - (totalRungs * rungMargins);
                            const rungHeight = Math.max(35, Math.floor(availableHeight / totalRungs));
                            
                            rung.style.height = `${rungHeight}px`;
                            rung.style.minHeight = `${rungHeight}px`;
                            rung.style.maxHeight = `${rungHeight}px`;
                            
                            // No text content - clean rungs
                        } else {
                            // Desktop: Keep original letter box style
                            const wordDisplay = document.createElement('div');
                            wordDisplay.className = 'word-display';
                            
                            // Create letter boxes for loading
                            const letterCount = isFinish ? 6 : 4 + (i % 3);
                            for (let j = 0; j < letterCount; j++) {
                                const letterBox = document.createElement('div');
                                letterBox.className = 'letter-box';
                                letterBox.style.opacity = '0.3';
                                wordDisplay.appendChild(letterBox);
                            }
                            
                            rung.appendChild(wordDisplay);
                        }
                        
                        // Only add hints for desktop, not mobile rectangles
                        if (!isFinish && !isMobile) {
                            const hint = document.createElement('div');
                            hint.className = 'word-hint';
                            hint.innerHTML = '&nbsp;'; // Empty space to maintain height
                            rung.appendChild(hint);
                        }
                        
                        ladderEl.appendChild(rung);
                    });
                }
                
                // Animate loading rungs
                const isMobile = window.innerWidth <= 480;
                const animationDelay = isMobile ? 400 : 600; // Delay first rung to sync after chime starts
                
                for (let i = 0; i < 6; i++) {
                    // For mobile, animate bottom to top (reverse order for upward building effect)
                    const animationIndex = isMobile ? (5 - i) : i;
                    // Sync with chime sound: each rung appears with each chime note (200ms intervals)
                    const intervalTiming = isMobile ? 200 : 150;
                    const delay = animationDelay + (animationIndex * intervalTiming);
                    
                    setTimeout(() => {
                        const desktopRung = document.getElementById(`loading-rung-${i}`);
                        const mobileRung = document.getElementById(`mobile-loading-rung-${i}`);
                        
                        // Apply different animations for desktop vs mobile
                        if (desktopRung) {
                            desktopRung.classList.add('loading-animation');
                            setTimeout(() => {
                                desktopRung.classList.remove('loading-animation');
                            }, 800);
                        }
                        
                        if (mobileRung) {
                            // Fast mobile animation - matches chime timing
                            mobileRung.classList.add('mobile-loading-animation');
                            mobileRung.style.opacity = '1';
                            
                            // Remove animation class quickly
                            setTimeout(() => {
                                mobileRung.classList.remove('mobile-loading-animation');
                            }, 150);
                        }
                    }, delay);
                }
                
                // Complete loading after all animations - sync with chime
                const intervalTiming = isMobile ? 200 : 150;
                const animationDuration = isMobile ? 200 : 800;
                const totalTime = animationDelay + (5 * intervalTiming) + animationDuration + 200; // Mobile: ~1500ms total to match chime
                setTimeout(() => {
                    resolve();
                }, totalTime);
            });
        }

        // Hint System - Click on letter boxes to reveal hints
        function setupHintSystem() {
            // Add click listeners to all interactive letter boxes
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('letter-box') && e.target.classList.contains('interactive')) {
                    handleLetterBoxClick(e.target);
                }
            });
        }
        
        function handleLetterBoxClick(letterBox) {
            // Check if hints are available
            if (window.gameState.hintsRemaining <= 0) {
                return; // Silent failure when no hints left
            }
            
            // Check if this letter is already revealed
            const isRevealed = letterBox.dataset.isRevealed === 'true';
            const isHintRevealed = letterBox.classList.contains('hint-revealed');
            
            if (isRevealed || isHintRevealed) {
                return; // Don't hint already revealed letters
            }
            
            // Check if this is the current word
            const wordIndex = parseInt(letterBox.dataset.wordIndex);
            if (wordIndex !== window.gameState.currentRungIndex) {
                return; // Only allow hints on current word
            }
            
            // Use a hint to reveal this letter
            useHint(letterBox);
        }
        
        function useHint(letterBox) {
            // Decrease hints remaining
            window.gameState.hintsRemaining--;
            window.gameState.hintsUsed++;
            
            // Update hints display
            document.getElementById('hints-remaining').textContent = window.gameState.hintsRemaining;
            const mobileHintsRemaining = document.getElementById('mobile-hints-remaining');
            if (mobileHintsRemaining) mobileHintsRemaining.textContent = window.gameState.hintsRemaining;
            
            // Reveal the letter with hint styling
            const correctLetter = letterBox.dataset.correctLetter;
            letterBox.textContent = correctLetter;
            
            // Remove any conflicting classes first
            letterBox.classList.remove('user-typed', 'current', 'typed-through');
            
            // Add hint classes
            letterBox.classList.add('hint-revealed', 'filled');
            letterBox.dataset.isRevealed = 'true'; // Important: this makes it work with auto-correct
            
            // Force the hint styling with inline styles - orange text, white background initially
            letterBox.style.backgroundColor = 'white';
            letterBox.style.borderColor = '#d3d6da';
            letterBox.style.color = '#ff8c42';
            
            // Update the mobile version too
            const wordIndex = letterBox.dataset.wordIndex;
            const letterIndex = letterBox.dataset.letterIndex;
            const mobileLetterBox = document.querySelector(`#mobile-ladder .letter-box[data-word-index="${wordIndex}"][data-letter-index="${letterIndex}"]`);
            if (mobileLetterBox) {
                mobileLetterBox.classList.add('filled', 'hint-revealed');
                mobileLetterBox.textContent = correctLetter;
                mobileLetterBox.dataset.isRevealed = 'true';
                mobileLetterBox.style.backgroundColor = 'white';
                mobileLetterBox.style.borderColor = '#d3d6da';
                mobileLetterBox.style.color = '#ff8c42';
            }
            
            // Add time penalty (30 seconds)
            addTimePenalty();
            
            // Play hint sound
            playSound('hint');
            vibrate([100, 50, 100]);
            
            console.log('Hint used on letter:', correctLetter, letterBox);
        }

        // Mobile Keyboard Handler
        function setupMobileKeyboard() {
            const mobileKeyboard = document.getElementById('mobile-keyboard');
            if (mobileKeyboard) {
                mobileKeyboard.addEventListener('click', (e) => {
                    if (e.target.classList.contains('keyboard-key')) {
                        e.preventDefault();
                        const key = e.target.dataset.key;
                        
                        console.log('Mobile key pressed:', key);
                        
                        // Add visual feedback
                        e.target.style.transform = 'scale(0.95)';
            setTimeout(() => {
                            e.target.style.transform = 'scale(1)';
            }, 100);
            
                        // Handle different key types
                        if (key === 'BACKSPACE') {
                            handleBackspace();
                            playSound('type');
                            vibrate(30);
                        } else if (key === 'HINT') {
                            // Show hint instruction popup
                            showHintPopup();
                            playSound('hint');
                            vibrate([100, 50, 100]);
                        } else if (key.match(/^[A-Z]$/)) {
                            addLetterToWord(key);
                            playSound('type');
                            vibrate(50);
                        }
                    }
                });
            }
        }
        
        // Sound System

        function playSound(type) {
            // Check global sound preference
            const globalSoundMuted = localStorage.getItem('sound_muted') === 'true';
            if (globalSoundMuted) return;
            
            // Create audio context if it doesn't exist
            if (!window.audioContext) {
                try {
                    window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    return; // Audio not supported
                }
            }
            
            const ctx = window.audioContext;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            const filterNode = ctx.createBiquadFilter();
            
            // Add low-pass filter to reduce harshness and improve speaker quality
            filterNode.type = 'lowpass';
            filterNode.frequency.setValueAtTime(2000, ctx.currentTime); // Cut harsh high frequencies
            filterNode.Q.setValueAtTime(1, ctx.currentTime);
            
            oscillator.connect(filterNode);
            filterNode.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            // Different sounds for different events
            switch (type) {
                case 'type':
                    // Typing sound with heavier end thump
                    // High click component
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(600, ctx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(400, ctx.currentTime + 0.02);
                    gainNode.gain.setValueAtTime(0.04, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.04);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.04);
                    
                    // Add heavier low-end thump at the end
                    const thumpOsc = ctx.createOscillator();
                    const thumpGain = ctx.createGain();
                    thumpOsc.connect(thumpGain);
                    thumpGain.connect(ctx.destination);
                    thumpOsc.type = 'sine';
                    thumpOsc.frequency.setValueAtTime(120, ctx.currentTime + 0.015);
                    thumpOsc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.06);
                    thumpGain.gain.setValueAtTime(0.08, ctx.currentTime + 0.015);
                    thumpGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.06);
                    thumpOsc.start(ctx.currentTime + 0.015);
                    thumpOsc.stop(ctx.currentTime + 0.06);
                    break;
                case 'correct':
                    // Pleasant bell chime with harmonics for better speaker quality
                    [349, 440, 523].forEach((freq, i) => { // F-A-C chord
                        // Main tone
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(1500, ctx.currentTime + i * 0.08);
                        filter.Q.setValueAtTime(0.5, ctx.currentTime + i * 0.08);
                        
                        osc.type = 'triangle'; // Warmer than sine, less harsh than square
                        osc.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.08);
                        gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.08);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.08 + 0.6);
                        osc.start(ctx.currentTime + i * 0.08);
                        osc.stop(ctx.currentTime + i * 0.08 + 0.6);
                        
                        // Add subtle harmonic for richness
                        const harmonic = ctx.createOscillator();
                        const harmonicGain = ctx.createGain();
                        const harmonicFilter = ctx.createBiquadFilter();
                        
                        harmonicFilter.type = 'lowpass';
                        harmonicFilter.frequency.setValueAtTime(1200, ctx.currentTime + i * 0.08);
                        
                        harmonic.type = 'sine';
                        harmonic.connect(harmonicFilter);
                        harmonicFilter.connect(harmonicGain);
                        harmonicGain.connect(ctx.destination);
                        harmonic.frequency.setValueAtTime(freq * 2, ctx.currentTime + i * 0.08); // Octave harmonic
                        harmonicGain.gain.setValueAtTime(0.05, ctx.currentTime + i * 0.08); // Much quieter harmonic
                        harmonicGain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.08 + 0.4);
                        harmonic.start(ctx.currentTime + i * 0.08);
                        harmonic.stop(ctx.currentTime + i * 0.08 + 0.4);
                    });
                    break;
                case 'wrong':
                    // Natural, gentle error sound (like a soft "uh-oh")
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(220, ctx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(180, ctx.currentTime + 0.15);
                    oscillator.frequency.exponentialRampToValueAtTime(160, ctx.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.15);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.3);
                    break;
                case 'finish':
                    // Extended triumphant victory fanfare with rich harmonics
                    [262, 330, 392, 523, 659, 784, 523].forEach((freq, i) => { // C-E-G-C-E-G-C progression
                        // Main tone with filtering
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(2000, ctx.currentTime + i * 0.15);
                        filter.Q.setValueAtTime(0.7, ctx.currentTime + i * 0.15);
                        
                        osc.type = 'triangle'; // Warmer, richer tone
                        osc.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.15);
                        gain.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.15 + 1.2);
                        osc.start(ctx.currentTime + i * 0.15);
                        osc.stop(ctx.currentTime + i * 0.15 + 1.2);
                        
                        // Add fifth harmonic for richness
                        const harmonic = ctx.createOscillator();
                        const harmonicGain = ctx.createGain();
                        const harmonicFilter = ctx.createBiquadFilter();
                        
                        harmonicFilter.type = 'lowpass';
                        harmonicFilter.frequency.setValueAtTime(1500, ctx.currentTime + i * 0.15);
                        
                        harmonic.type = 'sine';
                        harmonic.connect(harmonicFilter);
                        harmonicFilter.connect(harmonicGain);
                        harmonicGain.connect(ctx.destination);
                        harmonic.frequency.setValueAtTime(freq * 1.5, ctx.currentTime + i * 0.15); // Perfect fifth
                        harmonicGain.gain.setValueAtTime(0.08, ctx.currentTime + i * 0.15);
                        harmonicGain.gain.exponentialRampToValueAtTime(0.005, ctx.currentTime + i * 0.15 + 1.0);
                        harmonic.start(ctx.currentTime + i * 0.15);
                        harmonic.stop(ctx.currentTime + i * 0.15 + 1.0);
                    });
                    break;
                case 'loading':
                    // Gentle ascending loading sound with soft filtering - 6 chimes to match 6 rungs
                    [200, 250, 300, 350, 400, 450].forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        const filter = ctx.createBiquadFilter();
                        
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(1000, ctx.currentTime + i * 0.2); // 200ms to match rung timing
                        filter.Q.setValueAtTime(0.3, ctx.currentTime + i * 0.2);
                        
                        osc.type = 'triangle'; // Softer than sine
                        osc.connect(filter);
                        filter.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.2);
                        gain.gain.setValueAtTime(0.08, ctx.currentTime + i * 0.2);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.2 + 0.5); // Longer sustain
                        osc.start(ctx.currentTime + i * 0.2);
                        osc.stop(ctx.currentTime + i * 0.2 + 0.5);
                    });
                    break;
                case 'hint':
                    // Hint sound - between type and correct, gentle positive acknowledgment
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(440, ctx.currentTime); // A note
                    oscillator.frequency.exponentialRampToValueAtTime(550, ctx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start(ctx.currentTime);
                    oscillator.stop(ctx.currentTime + 0.2);
                    
                    // Add a subtle harmonic for richness
                    const hintHarmonic = ctx.createOscillator();
                    const hintHarmonicGain = ctx.createGain();
                    hintHarmonic.connect(hintHarmonicGain);
                    hintHarmonicGain.connect(ctx.destination);
                    hintHarmonic.type = 'sine';
                    hintHarmonic.frequency.setValueAtTime(660, ctx.currentTime); // Fifth above
                    hintHarmonicGain.gain.setValueAtTime(0.03, ctx.currentTime);
                    hintHarmonicGain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
                    hintHarmonic.start(ctx.currentTime);
                    hintHarmonic.stop(ctx.currentTime + 0.15);
                    break;
                case 'failure':
                    // Game over failure sound - descending disappointed tone
                    [220, 185, 150, 120, 100].forEach((freq, i) => {
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.type = 'sine';
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.2);
                        gain.gain.setValueAtTime(0.25, ctx.currentTime + i * 0.2);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.2 + 0.8);
                        osc.start(ctx.currentTime + i * 0.2);
                        osc.stop(ctx.currentTime + i * 0.2 + 0.8);
                    });
                    break;
            }
        }

        // Vibration support
        function vibrate(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Desktop Keyboard Handler
        function setupDesktopKeyboard() {
            document.addEventListener('keydown', (e) => {
                // Check if game content is visible (either content switching or mobile game mode)
                const gameContent = document.getElementById('game-content');
                const isGameVisible = gameContent && (
                    gameContent.style.display !== 'none' || 
                    !gameContent.style.display ||
                    document.body.classList.contains('mobile-game-mode')
                );
                
                // Only handle keys during game mode and prevent if in input fields
                if (isGameVisible && !e.target.matches('input, textarea, select')) {
                    const key = e.key.toUpperCase();
                    console.log('Key pressed:', key, 'Game visible:', isGameVisible);
                    
                    if (key === 'BACKSPACE') {
                        e.preventDefault();
                        handleBackspace();
                        playSound('type');
                    } else if (key.match(/^[A-Z]$/)) {
                        e.preventDefault();
                        addLetterToWord(key);
                        playSound('type');
                    }
                } else {
                    console.log('Key ignored - Game visible:', isGameVisible, 'Target:', e.target.tagName);
                }
            });
        }

        // Timer System
        function startTimer() {
            window.gameState.startTime = Date.now();
            window.gameState.timerInterval = setInterval(() => {
                const elapsed = Date.now() - window.gameState.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timer').textContent = timeText;
                
                // Sync mobile timer
                const mobileTimer = document.getElementById('mobile-timer');
                if (mobileTimer) mobileTimer.textContent = timeText;
            }, 1000);
        }
        

        
        function addTimePenalty() {
            // Add 30 seconds by subtracting 30000ms from start time
            if (window.gameState.startTime) {
                window.gameState.startTime -= 30000;
                
                // Force timer update immediately to show the penalty
                const elapsed = Date.now() - window.gameState.startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timer').textContent = timeText;
                const mobileTimer = document.getElementById('mobile-timer');
                if (mobileTimer) mobileTimer.textContent = timeText;
            }
            
            // Show red popup
            showTimePenaltyPopup();
        }

        // Build share payload (matching old format)
        function buildShareData() {
            const timeElem = document.getElementById('completion-time');
            const timeText = timeElem ? timeElem.textContent.trim() : '';
            
            // Get current date in the old format
            const today = new Date();
            const currentDate = today.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Calculate puzzle number (days since Jan 1, 2025)
            const puzzleNumber = Math.floor((today - new Date('2025-01-01')) / (1000 * 60 * 60 * 24)) + 1;
            
            const title = 'LADDER - Daily Word Puzzle';
            const text = `LADDER\nPuzzle #${puzzleNumber} • ${currentDate}\n${timeText}`;
            const url = 'https://ladder.game';
            return { title, text, url };
        }

        window.shareCompletion = async function() {
            const data = buildShareData();
            const button = document.querySelector('.completion-button.share');
            try {
                if (navigator.share) {
                    await navigator.share(data);
                } else {
                    await navigator.clipboard.writeText(data.text + '\n\n' + data.url);
                    // Show "Copied!" feedback
                    if (button) {
                        const originalText = button.textContent;
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 2000);
                    }
                }
            } catch (err) {
                console.error('Share failed:', err);
            }
        }

        window.copyShareLink = async function() {
            const data = buildShareData();
            const button = document.querySelector('.completion-button.copy');
            try {
                await navigator.clipboard.writeText(data.text + '\n\n' + data.url);
                // Show "Copied!" feedback
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            } catch (err) {
                console.error('Copy failed:', err);
            }
        }

        function showTimePenaltyPopup() {
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'time-penalty-popup';
            popup.textContent = '+30s';
            
            // Different positioning for mobile vs desktop
            const isMobile = window.innerWidth <= 480;
            let timer;
            
            if (isMobile) {
                // Mobile: use mobile timer and position in mobile header
                timer = document.getElementById('mobile-timer');
                const mobileHeader = document.querySelector('.mobile-header');
                
                if (mobileHeader && timer) {
                    const timerRect = timer.getBoundingClientRect();
                    popup.style.left = (timerRect.left - 70) + 'px'; // Further to the left of mobile timer
                    popup.style.top = (timerRect.top + (timerRect.height / 2) - 10) + 'px'; // Center with timer
                    popup.style.zIndex = '1000'; // Ensure it appears above other elements
                } else {
                    // Fallback for mobile - position in visible area
                    popup.style.top = '80px';  // Below mobile header
                    popup.style.left = '20%';
                    popup.style.transform = 'translateX(-50%)'; // Center horizontally
                    popup.style.zIndex = '1000';
                    console.log('Mobile popup fallback positioning');
                }
            } else {
                // Desktop: position to the left of timer in header
                timer = document.getElementById('timer');
                
                if (timer) {
                    const timerRect = timer.getBoundingClientRect();
                    popup.style.left = (timerRect.left - 70) + 'px'; // 70px to the left of timer
                    popup.style.top = (timerRect.top + (timerRect.height / 2) - 10) + 'px'; // Center with timer
                } else {
                    // Fallback positioning
                    popup.style.top = '60px';
                    popup.style.left = '20%';
                }
            }
            
            // Add to body
            document.body.appendChild(popup);
            
            // Remove popup after animation
            setTimeout(() => {
                popup.classList.add('fade-out');
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 300);
            }, 2000);
        }

        function showHintPopup() {
            // Create popup element
            const popup = document.createElement('div');
            popup.className = 'hint-popup';
            popup.innerHTML = 'Click any letter box to reveal it as a hint!<br><span style="font-size: 0.85em; opacity: 0.9;">+30 seconds time penalty</span>';
            
            // Center the popup on screen
            const isMobile = window.innerWidth <= 480;
            
            if (isMobile) {
                // Mobile: center in viewport, accounting for keyboard
                popup.style.top = '40%';
                popup.style.left = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            } else {
                // Desktop: center in viewport
                popup.style.top = '50%';
                popup.style.left = '50%';
                popup.style.transform = 'translate(-50%, -50%)';
            }
            
            // Add to body
            document.body.appendChild(popup);
            
            // Remove popup after animation
            setTimeout(() => {
                popup.classList.add('fade-out');
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 300);
            }, 3000); // Show for 3 seconds since it has more text
        }

        // PWA Installation Functions
        function dismissPWACard(button) {
            const card = button.closest('.pwa-install-card');
            if (card) {
                card.style.opacity = '0';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
                // Mark as dismissed so it doesn't show again
                window.pwaCardDismissed = true;
            }
        }

        window.dismissFailurePWACard = function(button) {
            const card = button.closest('.pwa-install-card');
            if (card) {
                card.style.opacity = '0';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
                // Mark as dismissed so it doesn't show again
                window.failurePwaCardDismissed = true;
            }
        }

        function installPWA() {
            // For testing, show an alert. In production, this would trigger the actual PWA install
            alert('PWA installation would be triggered here. This requires the beforeinstallprompt event.');
        }

        // PWA card setup for completion screen
        function setupPWAInstallCard() {
            // Only show PWA install card on mobile and when not already in PWA mode
            const isMobile = window.innerWidth <= 480;
            const isStandalone = window.navigator.standalone || 
                               window.matchMedia('(display-mode: standalone)').matches ||
                               window.matchMedia('(display-mode: fullscreen)').matches;
            
            // iOS Detection
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            const iosInstallCard = document.getElementById('pwa-install-card');
            const androidInstallCard = document.getElementById('android-pwa-install-card');
            
            // Check if user already dismissed this card
            if (window.pwaCardDismissed) {
                if (iosInstallCard) iosInstallCard.classList.add('hidden');
                if (androidInstallCard) androidInstallCard.classList.add('hidden');
                return;
            }
            
            if (isMobile && !isStandalone) {
                if (isIOS && iosInstallCard) {
                    // Show iOS install guide
                    iosInstallCard.style.display = 'block';
                    iosInstallCard.classList.remove('hidden');
                    if (androidInstallCard) androidInstallCard.classList.add('hidden');
                } else if (!isIOS && androidInstallCard) {
                    // Show Android install button
                    androidInstallCard.style.display = 'block';
                    androidInstallCard.classList.remove('hidden');
                    if (iosInstallCard) iosInstallCard.classList.add('hidden');
                }
            } else {
                if (iosInstallCard) iosInstallCard.classList.add('hidden');
                if (androidInstallCard) androidInstallCard.classList.add('hidden');
            }
        }

        // PWA card setup for completion screen (mobile only)
        function setupCompletionPWAInstallCard() {
            // Only show PWA install card on mobile and when not already in PWA mode
            const isMobile = window.innerWidth <= 480;
            const isStandalone = window.navigator.standalone || 
                               window.matchMedia('(display-mode: standalone)').matches ||
                               window.matchMedia('(display-mode: fullscreen)').matches;
            
            const pwaInstallCard = document.getElementById('completion-pwa-install-card');
            
            // Check if user already dismissed this card
            if (window.pwaCardDismissed) {
                if (pwaInstallCard) pwaInstallCard.style.display = 'none';
                return;
            }
            
            // Show clean PWA card only on mobile if not in PWA mode
            if (isMobile && !isStandalone && pwaInstallCard) {
                pwaInstallCard.style.display = 'block';
                console.log('Showing PWA install card on completion screen (mobile only)');
            } else if (pwaInstallCard) {
                pwaInstallCard.style.display = 'none';
            }
        }

        // Dismiss completion PWA card function
        window.dismissCompletionPWACard = function(button) {
            const card = button.closest('.signup-card');
            if (card) {
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.style.display = 'none';
                }, 300);
                // Mark as dismissed so it doesn't show again
                window.pwaCardDismissed = true;
            }
        }

        // PWA card setup for failure screen
        function setupFailurePWAInstallCard() {
            // Only show PWA install card on mobile and when not already in PWA mode
            const isMobile = window.innerWidth <= 480;
            const isStandalone = window.navigator.standalone || 
                               window.matchMedia('(display-mode: standalone)').matches ||
                               window.matchMedia('(display-mode: fullscreen)').matches;
            
            // iOS Detection
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            const iosInstallCard = document.getElementById('failure-pwa-install-card');
            const androidInstallCard = document.getElementById('failure-android-pwa-install-card');
            
            // Check if user already dismissed this card
            if (window.failurePwaCardDismissed) {
                if (iosInstallCard) iosInstallCard.classList.add('hidden');
                if (androidInstallCard) androidInstallCard.classList.add('hidden');
                return;
            }
            
            if (isMobile && !isStandalone) {
                if (isIOS && iosInstallCard) {
                    // Show iOS install guide
                    iosInstallCard.style.display = 'block';
                    iosInstallCard.classList.remove('hidden');
                    if (androidInstallCard) androidInstallCard.classList.add('hidden');
                } else if (!isIOS && androidInstallCard) {
                    // Show Android install button
                    androidInstallCard.style.display = 'block';
                    androidInstallCard.classList.remove('hidden');
                    if (iosInstallCard) iosInstallCard.classList.add('hidden');
                }
            } else {
                if (iosInstallCard) iosInstallCard.classList.add('hidden');
                if (androidInstallCard) androidInstallCard.classList.add('hidden');
            }
        }

        // More Puzzles Signup Card Functions
        function setupMorePuzzlesSignupCard() {
            // For now, always show signup card since we don't have authentication yet
            const signupCard = document.getElementById('more-puzzles-signup-card');
            const signupButton = document.getElementById('more-puzzles-signup-primary');
            
            if (signupCard) signupCard.style.display = 'block';
            if (signupButton) {
                signupButton.onclick = () => {
                    // Redirect to signup page with completion context
                    window.location.href = './signup.html?from=daily-completion';
                };
            }
        }

        function setupFailureMorePuzzlesSignupCard() {
            // For now, always show signup card since we don't have authentication yet
            const signupCard = document.getElementById('failure-more-puzzles-signup-card');
            const signupButton = document.getElementById('failure-more-puzzles-signup-primary');
            
            if (signupCard) signupCard.style.display = 'block';
            if (signupButton) {
                signupButton.onclick = () => {
                    // Redirect to signup page with failure context
                    window.location.href = './signup.html?from=daily-failure';
                };
            }
        }

        // LadderGame Class - Minimal integration with existing game logic
        class LadderGame {
            constructor(databasePuzzle = null) {
                console.log('LadderGame constructor called');
                
                // Use database puzzle if provided, otherwise keep existing hardcoded puzzle
                if (databasePuzzle) {
                    console.log('Using database puzzle:', databasePuzzle.puzzle.theme);
                    // Update the existing gameState with database puzzle
                    window.gameState.currentPuzzle = {
                        theme: databasePuzzle.puzzle.theme,
                        words: databasePuzzle.puzzle.words.map(wordData => ({
                            word: wordData.word,
                            hint: wordData.hint || wordData.clue, // Use hint or clue from database
                            revealed_letters: wordData.revealPattern ? 
                                wordData.revealPattern.map((revealed, index) => revealed ? index : null).filter(i => i !== null) :
                                [] // Convert revealPattern back to revealed_letters indices
                        }))
                    };
                    // Add FINISH word
                    window.gameState.currentPuzzle.words.push({ word: 'FINISH', hint: '', revealed_letters: [] });
                    this.puzzleNumber = databasePuzzle.puzzleNumber;
                } else {
                    console.log('Using existing hardcoded puzzle');
                    this.puzzleNumber = null;
                }
                
                // Store reference for completion tracking
                this.currentPuzzle = window.gameState.currentPuzzle;
                this.gameEnded = false;
                this.startTime = Date.now();
                this.hintsUsed = 0;
            }
            
            // Essential method for failure tracking
            async trackFailure(timeString) {
                try {
                    console.log('Tracking failure:', timeString);
                    
                    // Skip tracking in testing mode
                    if (window.TESTING_MODE) {
                        console.log('Testing mode: Skipping failure tracking');
                        return;
                    }
                    
                    // Check if user is authenticated
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    
                    if (user) {
                        // Authenticated user - save to database
                        const today = new Date().toISOString().split('T')[0];
                        
                        // Convert time string to PostgreSQL interval format
                        const [minutes, seconds] = timeString.split(':').map(Number);
                        const totalSeconds = minutes * 60 + seconds;
                        const completionInterval = `${totalSeconds} seconds`;
                        
                        const { error } = await window.supabaseClient
                            .from('puzzle_completions')
                            .upsert({
                                user_id: user.id,
                                puzzle_date: today,
                                puzzle_name: this.currentPuzzle.theme,
                                completed: false, // Failed
                                completion_time: completionInterval, // Time when failed
                                hints_used: window.gameState.hintsUsed || 0,
                                tries_used: window.gameState.wrongGuesses || 0,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id,puzzle_date'
                            });
                            
                        if (error) {
                            console.error('Error tracking failure:', error);
                        } else {
                            console.log('Puzzle failure tracked successfully');
                        }
                    } else {
                        // Non-authenticated user - set cookie
                        this.setPuzzlePlayedCookie();
                    }
                } catch (error) {
                    console.error('Error in trackFailure:', error);
                }
            }
            
            // Essential method for completion tracking
            async trackCompletion(timeString) {
                try {
                    console.log('Tracking completion:', timeString);
                    
                    // Skip tracking in testing mode
                    if (window.TESTING_MODE) {
                        console.log('Testing mode: Skipping completion tracking');
                        return;
                    }
                    
                    // Check if user is authenticated
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    
                    if (user) {
                        // Authenticated user - save to database
                        const today = new Date().toISOString().split('T')[0];
                        
                        // Convert time string to PostgreSQL interval format
                        const [minutes, seconds] = timeString.split(':').map(Number);
                        const totalSeconds = minutes * 60 + seconds;
                        const completionInterval = `${totalSeconds} seconds`;
                        
                        const { error } = await window.supabaseClient
                            .from('puzzle_completions')
                            .upsert({
                                user_id: user.id,
                                puzzle_date: today,
                                puzzle_name: this.currentPuzzle.theme,
                                completed: true,
                                completion_time: completionInterval, // PostgreSQL interval format
                                hints_used: window.gameState.hintsUsed || 0,
                                tries_used: window.gameState.wrongGuesses || 0,
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }, {
                                onConflict: 'user_id,puzzle_date'
                            });
                            
                        if (error) {
                            console.error('Error tracking completion:', error);
                        } else {
                            console.log('Puzzle completion tracked successfully');
                        }
                    } else {
                        // Non-authenticated user - set cookie
                        this.setPuzzlePlayedCookie();
                    }
                } catch (error) {
                    console.error('Error in trackCompletion:', error);
                }
            }
            
            // Calculate next 3am ET reset time (copied from play.html)
            getNextPuzzleResetTime() {
                const now = new Date();
                
                // Get current date/time in Eastern timezone using Intl
                const etFormatter = new Intl.DateTimeFormat('en-US', {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                
                const etParts = etFormatter.formatToParts(now);
                const etYear = parseInt(etParts.find(part => part.type === 'year').value);
                const etMonth = parseInt(etParts.find(part => part.type === 'month').value) - 1; // 0-indexed
                const etDay = parseInt(etParts.find(part => part.type === 'day').value);
                const etHour = parseInt(etParts.find(part => part.type === 'hour').value);
                
                // Create today at 3am ET
                const todayAt3amET = new Date();
                todayAt3amET.setFullYear(etYear, etMonth, etDay);
                todayAt3amET.setHours(3, 0, 0, 0);
                
                // Determine if we need today's or tomorrow's 3am ET
                let targetResetDate;
                if (etHour >= 3) {
                    // Past 3am ET, so next reset is tomorrow at 3am ET
                    targetResetDate = new Date(todayAt3amET);
                    targetResetDate.setDate(targetResetDate.getDate() + 1);
                } else {
                    // Before 3am ET, so next reset is today at 3am ET  
                    targetResetDate = todayAt3amET;
                }
                
                // Convert from local interpretation to actual ET time
                const testLocal = new Date(targetResetDate);
                const testET = new Date(testLocal.toLocaleString('en-US', {timeZone: 'America/New_York'}));
                
                // Calculate the difference
                const offsetMs = testLocal.getTime() - testET.getTime();
                
                // Apply the offset to get the correct reset time
                const correctResetTime = new Date(targetResetDate.getTime() + offsetMs);
                
                return correctResetTime;
            }
            
            // Pack puzzle fetching (ported from play.html)
            async fetchPackPuzzle(packId, puzzleId) {
                try {
                    const client = window.supabaseClient;
                    if (!client) {
                        throw new Error('Supabase client not initialized');
                    }
                    
                    // Fetch puzzle from user's puzzle pack
                    const { data: { user } } = await client.auth.getUser();
                    if (!user) {
                        throw new Error('User not authenticated');
                    }
                    
                    // Check user access permissions
                    const { data: purchases } = await client
                        .from('user_purchases')
                        .select('*')
                        .eq('user_id', user.id)
                        .in('product_id', [packId, 'complete-pack', 'free-pack']);
                    
                    const ownedProducts = purchases ? purchases.map(p => p.product_id) : [];
                    const hasCompletePack = ownedProducts.includes('complete-pack');
                    const hasThisPack = ownedProducts.includes(packId);
                    
                    // Check access permissions based on pack type
                    let hasAccess = false;
                    if (packId === 'free-pack') {
                        hasAccess = hasThisPack || hasCompletePack;
                    } else if (packId === 'puzzle-pack' || packId === 'archive') {
                        hasAccess = hasThisPack || hasCompletePack;
                    } else {
                        hasAccess = hasThisPack || hasCompletePack;
                    }
                    
                    if (!hasAccess) {
                        throw new Error('User does not own this puzzle pack');
                    }
                    
                    // Fetch the specific puzzle from the pack
                    const { data: puzzle, error: puzzleError } = await client
                        .from('puzzle_pack')
                        .select('*')
                        .eq('id', puzzleId)
                        .single();
                    
                    if (puzzleError) {
                        throw puzzleError;
                    }
                    
                    // Get pack name for display
                    const { data: packInfo } = await client
                        .from('puzzle_packs')
                        .select('name')
                        .eq('id', packId)
                        .single();
                    
                    // Find puzzle index in pack for numbering
                    let puzzleIndex = 1;
                    if (packId === 'free-pack') {
                        const { data: allPuzzles } = await client
                            .from('free_pack_puzzles')
                            .select('id')
                            .order('pack_level')
                            .order('created_at');
                        puzzleIndex = (allPuzzles?.findIndex(p => p.id === puzzleId) || 0) + 1;
                    } else {
                        const { data: allPuzzles } = await client
                            .from('puzzle_pack')
                            .select('id')
                            .order('pack_level')
                            .order('created_at');
                        puzzleIndex = (allPuzzles?.findIndex(p => p.id === puzzleId) || 0) + 1;
                    }
                    
                    const packName = packInfo?.name || 'Puzzle Pack';
                    
                    // Process puzzle with letter reveals - use same format as daily puzzles
                    const puzzleWithReveals = {
                        ...puzzle,
                        words: puzzle.words.map((word, index) => ({
                            word: word.word,
                            clue: word.clue,
                            hint: word.hint,
                            revealPattern: Array.from({length: word.word.length}, (_, letterIndex) => 
                                word.revealed_letters?.includes(letterIndex) || false
                            )
                        }))
                    };
                    
                    return { 
                        puzzle: puzzleWithReveals, 
                        puzzleNumber: `${packName} #${puzzleIndex}`
                    };
                    
                } catch (error) {
                    console.error('Failed to fetch pack puzzle:', error);
                    throw error;
                }
            }
            
            // Cookie tracking for non-authenticated users
            setPuzzlePlayedCookie() {
                // Skip setting cookie in testing mode
                if (window.TESTING_MODE) {
                    console.log('Testing mode: Skipping completion cookie');
                    return;
                }
                
                // Use the same date format as checking function
                const today = getGameDayString(new Date());
                const cookieName = `ladder_played_${today}`;
                
                // Calculate next 3am ET reset time properly
                const now = new Date();
                const nextReset = this.getNextPuzzleResetTime();
                
                document.cookie = `${cookieName}=true; expires=${nextReset.toUTCString()}; path=/`;
                console.log('Set completion cookie for non-authenticated user:', cookieName);
            }
        }
        
        // Make LadderGame globally available
        window.LadderGame = LadderGame;

        // Initialize page with comprehensive error handling
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('Initializing page...');
                
                // Initialize core functions with individual error handling
                try {
                    setHeaderInfo();
                } catch (error) {
                    console.error('Error setting header info:', error);
                }
                
                try {
                    setupHintSystem();
                } catch (error) {
                    console.error('Error setting up hint system:', error);
                }
                
                try {
                    setupMobileKeyboard();
                } catch (error) {
                    console.error('Error setting up mobile keyboard:', error);
                }
                
                try {
                    setupDesktopKeyboard();
                } catch (error) {
                    console.error('Error setting up desktop keyboard:', error);
                }
                
                // Check if this is a pack puzzle (skip normal daily puzzle logic)
                const isPackPuzzle = window.puzzleParams.type === 'pack';
                const isArchivePuzzle = window.puzzleParams.type === 'historical';
                
                if (isPackPuzzle || isArchivePuzzle) {
                    // For pack/archive puzzles, go directly to game content
                    console.log(`${window.puzzleParams.type} puzzle detected - going directly to game`, window.puzzleParams);
                    showGameContent();
                    return; // Skip daily puzzle logic
                }
                
                // Original daily puzzle logic for when no pack parameters are present
                try {
                    // First, check if user is authenticated
                    const { data: { user } } = await window.supabaseClient.auth.getUser();
                    
                    if (user) {
                        // User is authenticated - check if they completed today's puzzle
                        const hasCompletedToday = await checkIfCompletedToday();
                        if (hasCompletedToday) {
                            // User already played today - go directly to countdown
                            console.log('Authenticated user already completed today\'s puzzle, showing countdown');
                            showCountdownContent();
                        } else {
                            // Authenticated user hasn't played today - redirect to home
                            console.log('Authenticated user hasn\'t played today, redirecting to home');
                            window.location.href = '/home';
                            return; // Stop further initialization
                        }
                    } else {
                        // Non-authenticated user - check completion and show countdown if completed
                        const hasCompletedToday = await checkIfCompletedToday();
                        if (hasCompletedToday) {
                            console.log('Non-authenticated user already completed today\'s puzzle, showing countdown');
                            showCountdownContent();
                        }
                        // If not completed, stay on landing page (normal flow)
                    }
                } catch (error) {
                    console.error('Error checking authentication/completion status on page load:', error);
                    // Continue with normal page load even if checks fail
                }
                
                console.log('Page initialization complete');
                
            } catch (error) {
                console.error('Critical error during page initialization:', error);
                // Show user-friendly error message if all initialization fails
                const body = document.body;
                if (body) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                        text-align: center;
                        color: var(--error-red);
                        z-index: 9999;
                    `;
                    errorDiv.innerHTML = `
                        <h3>Something went wrong</h3>
                        <p>Please refresh the page to try again.</p>
                        <button onclick="window.location.reload()" 
                                style="margin-top: 15px; padding: 10px 20px; background: var(--primary-orange); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Refresh Page
                        </button>
                    `;
                    body.appendChild(errorDiv);
                }
            }
        });
        
        // Context-aware screen setup functions
        async function setupCompletionScreenContextAware() {
            console.log('Setting up context-aware completion screen');
            
            // Determine puzzle context
            const isPackPuzzle = window.puzzleParams.type === 'pack';
            const isArchivePuzzle = window.puzzleParams.type === 'historical';
            const isDailyPuzzle = window.puzzleParams.type === 'daily';
            
            // Update the main completion card with context-aware navigation
            await updateCompletionCardWithContext(isPackPuzzle, isArchivePuzzle, isDailyPuzzle);
            
            // Set up secondary cards based on authentication and context
            await setupContextAwareSecondaryCards('completion');
        }
        
        async function setupFailureScreenContextAware() {
            console.log('Setting up context-aware failure screen');
            
            // Determine puzzle context
            const isPackPuzzle = window.puzzleParams.type === 'pack';
            const isArchivePuzzle = window.puzzleParams.type === 'historical';
            const isDailyPuzzle = window.puzzleParams.type === 'daily';
            
            // Update the main failure card with context-aware navigation
            await updateFailureCardWithContext(isPackPuzzle, isArchivePuzzle, isDailyPuzzle);
            
            // Set up secondary cards based on authentication and context
            await setupContextAwareSecondaryCards('failure');
        }
        
        async function updateCompletionCardWithContext(isPackPuzzle, isArchivePuzzle, isDailyPuzzle) {
            const completionCard = document.querySelector('#completion-content .card-completed');
            if (!completionCard) return;
            
            const buttonsContainer = completionCard.querySelector('.signup-buttons');
            if (!buttonsContainer) return;
            
            let navigationButtons = '';
            
            if (isPackPuzzle) {
                // Pack puzzle - show "Back to Pack" and "Next Puzzle"
                const packId = window.puzzleParams.packId;
                const packName = getPackDisplayName(packId);
                
                navigationButtons = `
                    <button class="signup-button primary" id="completion-share" onclick="shareCompletion()">Share</button>
                    <button class="signup-button primary" id="completion-back-to-pack" onclick="backToPackPuzzles('${packId}')">Back to ${packName}</button>
                `;
            } else if (isArchivePuzzle) {
                // Archive puzzle - show "Back to Archive" and "Share"
                navigationButtons = `
                    <button class="signup-button primary" id="completion-share" onclick="shareCompletion()">Share</button>
                    <button class="signup-button primary" id="completion-back-to-archive" onclick="backToPackPuzzles('archive')">Back to Archive</button>
                `;
            } else {
                // Daily puzzle - show "Share" and "Next Puzzle" (tomorrow's)
                navigationButtons = `
                    <button class="signup-button primary" id="completion-share" onclick="shareCompletion()">Share</button>
                    <button class="signup-button primary" id="completion-next" onclick="showCountdownContent()">Next Puzzle</button>
                `;
            }
            
            buttonsContainer.innerHTML = navigationButtons;
        }
        
        async function updateFailureCardWithContext(isPackPuzzle, isArchivePuzzle, isDailyPuzzle) {
            const failureCard = document.querySelector('#failure-content .card-failed');
            if (!failureCard) return;
            
            const buttonsContainer = failureCard.querySelector('.signup-buttons');
            if (!buttonsContainer) return;
            
            let navigationButtons = '';
            
            if (isPackPuzzle) {
                // Pack puzzle - show "Try Again" and "Back to Pack"
                const packId = window.puzzleParams.packId;
                const packName = getPackDisplayName(packId);
                
                navigationButtons = `
                    <button class="signup-button primary" id="failure-try-again" onclick="retryGame()">Try Again</button>
                    <button class="signup-button primary" id="failure-back-to-pack" onclick="backToPackPuzzles('${packId}')">Back to ${packName}</button>
                `;
            } else if (isArchivePuzzle) {
                // Archive puzzle - show "Try Again" and "Back to Archive"
                navigationButtons = `
                    <button class="signup-button primary" id="failure-try-again" onclick="retryGame()">Try Again</button>
                    <button class="signup-button primary" id="failure-back-to-archive" onclick="backToPackPuzzles('archive')">Back to Archive</button>
                `;
            } else {
                // Daily puzzle - show "Try Again" and "Next Puzzle" (tomorrow's)
                navigationButtons = `
                    <button class="signup-button primary" id="failure-try-again" onclick="retryGame()">Try Again</button>
                    <button class="signup-button primary" id="failure-countdown-button" onclick="showCountdownContent()">Next Puzzle</button>
                `;
            }
            
            buttonsContainer.innerHTML = navigationButtons;
        }
        
        async function setupContextAwareSecondaryCards(screenType) {
            try {
                // Check authentication status
                const { data: { user } } = await window.supabaseClient.auth.getUser();
                const isAuthenticated = !!user;
                
                // Determine puzzle context
                const isPackPuzzle = window.puzzleParams.type === 'pack';
                const isArchivePuzzle = window.puzzleParams.type === 'historical';
                const isDailyPuzzle = window.puzzleParams.type === 'daily';
                
                console.log('Setting up secondary cards:', { 
                    screenType, 
                    isAuthenticated, 
                    isPackPuzzle, 
                    isArchivePuzzle, 
                    isDailyPuzzle 
                });
                
                // Set up PWA card (for mobile users not in PWA)
                if (screenType === 'completion') {
                    setupCompletionPWAInstallCard();
                } else {
                    setupFailurePWAInstallCard();
                }
                
                // Set up signup card only for unauthenticated users playing daily puzzles
                const shouldShowSignupCard = !isAuthenticated && isDailyPuzzle;
                
                if (shouldShowSignupCard) {
                    console.log('Showing signup card for unauthenticated daily puzzle player');
                    const signupCard = document.querySelector(`#${screenType}-content .signup-card:last-child`);
                    if (signupCard && signupCard.innerHTML.includes('Want more puzzles?')) {
                        signupCard.style.display = 'block';
                    }
                } else {
                    console.log('Hiding signup card - user is authenticated or playing pack puzzle');
                    const signupCard = document.querySelector(`#${screenType}-content .signup-card:last-child`);
                    if (signupCard && signupCard.innerHTML.includes('Want more puzzles?')) {
                        signupCard.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error setting up context-aware secondary cards:', error);
                // Fallback to showing all cards
                if (screenType === 'completion') {
                    setupCompletionPWAInstallCard();
                } else {
                    setupFailurePWAInstallCard();
                }
            }
        }
        
        function getPackDisplayName(packId) {
            const packNames = {
                'free-pack': 'Free Pack',
                'complete-pack': 'Complete Pack', 
                'puzzle-pack': 'Puzzle Pack',
                'archive': 'Archive'
            };
            return packNames[packId] || 'Pack';
        }
        
        // Navigation function to go back to pack puzzles
        window.backToPackPuzzles = function(packId) {
            window.location.href = `./pack-puzzles.html?pack=${packId}`;
        };
        
        
    </script>
    
    <!-- PWA Initialization -->
    <script type="module">
        import { initializePWA } from './assets/js/pwa.js';
        
        // Initialize PWA features
        document.addEventListener('DOMContentLoaded', () => {
            initializePWA();
        });
    </script>
</body>
</html>